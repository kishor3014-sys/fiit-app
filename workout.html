<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>FitCoach Pro - Webhook Integrated</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #374151; }
    ::-webkit-scrollbar-thumb { background: #6B7280; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

    @media (max-width: 1024px) {
      .split-layout { flex-direction: column !important; }
      .left-panel, .right-panel { width: 100% !important; max-width: 100% !important; }
        /* Mobile: right panel full width + natural height */
  .right-panel {
    max-height: none !important;
    min-height: 300px;
    overflow-y: visible;
    padding-bottom: 80px;
  }
    }

    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .action-btn {
        padding: 14px 28px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 180px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
    }

    .action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .action-btn:hover::before {
        left: 100%;
    }

    .pdf-btn {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
    }

    .pdf-btn:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
    }

    .whatsapp-btn {
        background: linear-gradient(135deg, #25d366, #128c7e);
        color: white;
    }

    .whatsapp-btn:hover {
        background: linear-gradient(135deg, #128c7e, #075e54);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(37, 211, 102, 0.4);
    }

    .action-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .pulse { animation: pulse 2s infinite; }

    /* Hide webhook checkbox - invisible but present in code */
    #webhook-container {
        display: none;
    }

    /* Day button active state animation */
    .day-btn {
      transition: all 0.3s ease;
    }

    .day-btn.active {
      background: linear-gradient(135deg, #3B82F6, #1D4ED8) !important;
      color: white !important;
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
      animation: dayButtonGlow 0.5s ease-in-out;
    }

    @keyframes dayButtonGlow {
      0% { box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
      50% { box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6); }
      100% { box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
    }

    /* Exercise URL buttons styling */
    .exercise-url-buttons {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
    }

    .url-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    .image-btn {
        background: linear-gradient(135deg, #3B82F6, #1E40AF);
        color: white;
    }

    .image-btn:hover {
        background: linear-gradient(135deg, #1E40AF, #1E3A8A);
        transform: translateY(-1px);
    }

    .video-btn {
        background: linear-gradient(135deg, #EF4444, #DC2626);
        color: white;
    }

    .video-btn:hover {
        background: linear-gradient(135deg, #DC2626, #B91C1C);
        transform: translateY(-1px);
    }

    /* NEW: Enhanced Nutrition Section Styles */
    .nutrition-toggle {
        display: flex;
        background: #374151;
        border-radius: 12px;
        padding: 4px;
        margin-bottom: 20px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .nutrition-toggle-btn {
        flex: 1;
        padding: 12px 16px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: transparent;
        color: #9CA3AF;
    }

    .nutrition-toggle-btn.active {
        background: linear-gradient(135deg, #10B981, #059669);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .meal-card {
        background: linear-gradient(135deg, #1F2937, #111827);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
        border-left: 4px solid #10B981;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .meal-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
    }

    .meal-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
    }

    .meal-icon {
        width: 32px;
        height: 32px;
        margin-right: 12px;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .meal-title {
        font-size: 18px;
        font-weight: bold;
        color: #F9FAFB;
        margin: 0;
    }

    .meal-description {
        color: #D1D5DB;
        font-size: 15px;
        line-height: 1.6;
        margin-bottom: 12px;
    }

    .meal-stats {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
    }

    .stat-item {
        background: rgba(16, 185, 129, 0.1);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        color: #10B981;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .nutrition-tips {
        background: linear-gradient(135deg, #7C3AED, #5B21B6);
        border-radius: 16px;
        padding: 20px;
        margin-top: 20px;
    }

    .nutrition-tips h4 {
        color: white;
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
    }

    .nutrition-tips ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .nutrition-tips li {
        color: #E5E7EB;
        padding: 8px 0;
        padding-left: 24px;
        position: relative;
        font-size: 14px;
        line-height: 1.5;
    }

    .nutrition-tips li:before {
        content: "üí°";
        position: absolute;
        left: 0;
        top: 8px;
    }

    .daily-calories {
        text-align: center;
        background: linear-gradient(135deg, #F59E0B, #D97706);
        color: white;
        padding: 16px;
        border-radius: 16px;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: bold;
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
    }
  </style>
</head>
<body class="bg-gray-900 min-h-screen overflow-hidden">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function(){
  // Configuration
  const WEBHOOK_URL = 'https://shashii7234.app.n8n.cloud/webhook/generate-workout';

  // Supabase Configuration
  const SUPABASE_URL = 'https://ignyigcedltdwwefzbtl.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlnbnlpZ2NlZGx0ZHd3ZWZ6YnRsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2NDE4NDAsImV4cCI6MjA3MDIxNzg0MH0.4wR8w-cY94k9jBRdEl8bE9gfFa6of3eA6qiBd_37r3k';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;
  let userProfile = null;
  let currentLang = 'en';
  let currentNutritionType = 'vegetarian';
  let currentWorkout = null;
  let selectedDayKey = null;

  /* ----------------------------- Sample Data with Enhanced Nutrition ----------------------------- */
  const sampleWorkoutData = {
    clientInfo: { 
      name: "John Doe", 
      age: 28, 
      goal: "Muscle Gain", 
      workoutDays: "3 days per week", 
      fitnessLevel: "Intermediate", 
      gender: "Male",
      height: 170,
      weight: 75,
      bmi: 26.0,
      equipment: "Full Gym"
    },
    workoutPlan: {
      day1: { title: "Upper Body Strength", duration: "45-60 minutes", exercises: [
        { 
          name: "Dynamic Warm-up", 
          type: "warmup", 
          sets: "1", 
          reps: "N/A", 
          duration: "10 minutes", 
          rest: "N/A", 
          description: "Light cardio, arm circles, shoulder rolls, and dynamic stretching to prepare muscles for workout.",
          imageUrl: "https://example.com/dynamic-warmup.jpg",
          videoUrl: "https://youtube.com/watch?v=warmup123"
        },
        { 
          name: "Push-ups", 
          type: "main", 
          sets: "3", 
          reps: "12-15", 
          duration: "N/A", 
          rest: "60 seconds", 
          description: "Standard push-ups focusing on chest, shoulders, and triceps.",
          imageUrl: "https://example.com/pushups.jpg",
          videoUrl: "https://youtube.com/watch?v=pushups456"
        },
        { 
          name: "Cool-down Stretch", 
          type: "cooldown", 
          sets: "1", 
          reps: "N/A", 
          duration: "10 minutes", 
          rest: "N/A", 
          description: "Static stretching focusing on chest, shoulders, and back muscles.",
          imageUrl: "https://example.com/cooldown-stretch.jpg",
          videoUrl: "https://youtube.com/watch?v=cooldown123"
        }
      ]},
      day2: { title: "Lower Body Power", duration: "45-60 minutes", exercises: [
        { 
          name: "Dynamic Warm-up", 
          type: "warmup", 
          sets: "1", 
          reps: "N/A", 
          duration: "10 minutes", 
          rest: "N/A", 
          description: "Light jogging, leg swings, and dynamic stretching.",
          imageUrl: "https://example.com/leg-warmup.jpg",
          videoUrl: "https://youtube.com/watch?v=legwarmup456"
        },
        { 
          name: "Squats", 
          type: "main", 
          sets: "3", 
          reps: "12-15", 
          duration: "N/A", 
          rest: "90 seconds", 
          description: "Bodyweight or weighted squats.",
          imageUrl: "https://example.com/squats.jpg",
          videoUrl: "https://youtube.com/watch?v=squats789"
        }
      ]},
      day3: { title: "Cardio & Core", duration: "30-45 minutes", exercises: [
        { 
          name: "Light Warm-up", 
          type: "warmup", 
          sets: "1", 
          reps: "N/A", 
          duration: "5 minutes", 
          rest: "N/A", 
          description: "Easy walking or light jogging.",
          imageUrl: "https://example.com/light-warmup.jpg",
          videoUrl: "https://youtube.com/watch?v=lightwarmup789"
        }
      ]}
    },
    // NEW: Enhanced Nutrition plan with vegetarian/non-vegetarian options
    nutritionPlan: {
      breakfast: "VEGETARIAN: Vegetable upma with mixed vegetables (300 calories) | NON-VEGETARIAN: Scrambled eggs with whole wheat toast (350 calories)",
      lunch: "VEGETARIAN: Paneer curry with quinoa and mixed vegetables (600 calories) | NON-VEGETARIAN: Grilled chicken breast with brown rice and salad (650 calories)",
      dinner: "VEGETARIAN: Moong dal khichdi with vegetables (500 calories) | NON-VEGETARIAN: Grilled fish with steamed broccoli and sweet potato (600 calories)",
      snacks: "VEGETARIAN: Roasted chickpeas with spices (150 calories) | NON-VEGETARIAN: Greek yogurt with berries and nuts (200 calories)",
      dailyCalories: "1800-2000 calories",
      nutritionTips: [
        "Drink at least 3-4 liters of water daily for optimal hydration",
        "Include protein in every meal for muscle recovery and building",
        "Eat complex carbs before workouts for sustained energy",
        "Have a post-workout meal within 30 minutes of exercising",
        "Include seasonal fruits and vegetables for optimal nutrition",
        "Practice portion control for effective meal management"
      ]
    },
    safetyReminders: ["Always warm up before starting your workout", "Maintain proper form throughout all exercises", "Start with lighter weights and gradually increase", "Stay hydrated during your workout", "Listen to your body and rest when needed", "Cool down and stretch after your workout"],
    progressionPathway: ["Week 1-2: Focus on learning proper form", "Week 3-4: Increase repetitions by 2-3 per set", "Week 5-6: Add 5-10% more weight or resistance", "Week 7-8: Introduce new exercise variations", "Continue progressive overload principle"],
    motivation: "Remember, every rep counts towards your goal. Stay consistent, trust the process, and celebrate small victories along the way. Your dedication today builds the strength of tomorrow!"
  };

  // DOM references
  let rightPanel, form, generateBtn, generateText, resetBtn, errorBox, errorText;

  // Enhanced Translation object with comprehensive translations including nutrition
  const labels = {
    en: {
      clientName: "Client Name *", age: "Age *", height: "Height (cm) *", weight: "Weight (kg) *",
      gender: "Gender *", equipment: "Available Equipment *", goal: "Fitness Goal *",
      workoutDays: "Workout Days per Week *", fitnessLevel: "Fitness Level *",
      generate: "üöÄ Generate Plan", reset: "üîÑ Reset Form",
      enterName: "Enter your name", enterAge: "Enter your age",
      selectGender: "Select Gender", selectEquipment: "Select Equipment", 
      selectGoal: "Select Goal", selectDays: "Select Days", selectLevel: "Select Level",
      male: "Male", female: "Female",
      fullGym: "Full Gym Equipment", homeGym: "Home Gym (Dumbbells/Bands)",
      bodyweight: "Bodyweight Only", minimal: "Minimal Equipment",
      weightLoss: "Weight Loss", muscleGain: "Muscle Gain", strengthTraining: "Strength Training",
      endurance: "Endurance", generalFitness: "General Fitness", toning: "Toning",
      oneDay: "1 days per week", twoDays: "2 days per week", threeDays: "3 days per week",
      fourDays: "4 days per week", fiveDays: "5 days per week", sixDays: "6 days per week", sevenDays: "7 days per week",
      beginner: "Beginner (0-6 months)", intermediate: "Intermediate (6 months - 2 years)", advanced: "Advanced (2+ years)",
      workoutPlan: "Your Workout Plan", client: "Client", schedule: "Schedule",
      goalAndLevel: "Goal & Level", heightWeight: "Height & Weight", bmi: "BMI", equipment: "Equipment",
      selectWorkoutDay: "Select Workout Day:", safetyReminders: "Safety & Form Reminders",
      progressionPathway: "Progression Pathway", motivationEncouragement: "Motivation & Encouragement",
      sets: "Sets", reps: "Reps", rest: "Rest", duration: "Duration",
      warmup: "WARMUP", main: "MAIN", cooldown: "COOLDOWN",
      downloadPDF: "Download PDF", shareSummary: "Share Summary", sharePDFWhatsApp: "Share PDF via WhatsApp",
      shareYourPlan: "Share Your Plan", shareDescription: "Download, share summary, or send PDF via WhatsApp",
      day: "Day", clientInformation: "CLIENT INFORMATION", name: "Name", years: "years", cm: "cm", kg: "kg",
      underweight: "Underweight", normal: "Normal", overweight: "Overweight", obese: "Obese",
      viewImage: "View Image", watchVideo: "Watch Video",
      basicDietPlan: "Basic Diet Plans (Nutrition)", vegetarian: "ü•¨ Vegetarian", nonVegetarian: "üçó Non-Vegetarian",
      breakfast: "Breakfast", lunch: "Lunch", dinner: "Dinner", snacks: "Snacks",
      dailyCalories: "Daily Target", nutritionTips: "Nutrition Tips", calories: "calories", protein: "protein"
    },
    hi: {
      clientName: "‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§®‡§æ‡§Æ *", age: "‡§Ü‡§Ø‡•Å *", height: "‡§≤‡§Ç‡§¨‡§æ‡§à (‡§∏‡•á‡§Æ‡•Ä) *", weight: "‡§µ‡§ú‡§® (‡§ï‡§ø‡§≤‡•ã) *",
      gender: "‡§≤‡§ø‡§Ç‡§ó *", equipment: "‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§â‡§™‡§ï‡§∞‡§£ *", goal: "‡§´‡§ø‡§ü‡§®‡•á‡§∏ ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø *",
      workoutDays: "‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§Æ‡•á‡§Ç ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§¶‡§ø‡§® *", fitnessLevel: "‡§´‡§ø‡§ü‡§®‡•á‡§∏ ‡§∏‡•ç‡§§‡§∞ *",
      generate: "üöÄ ‡§™‡•ç‡§≤‡§æ‡§® ‡§¨‡§®‡§æ‡§è‡§Ç", reset: "üîÑ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç",
      enterName: "‡§Ö‡§™‡§®‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç", enterAge: "‡§Ö‡§™‡§®‡•Ä ‡§Ü‡§Ø‡•Å ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç",
      selectGender: "‡§≤‡§ø‡§Ç‡§ó ‡§ö‡•Å‡§®‡•á‡§Ç", selectEquipment: "‡§â‡§™‡§ï‡§∞‡§£ ‡§ö‡•Å‡§®‡•á‡§Ç",
      selectGoal: "‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§ö‡•Å‡§®‡•á‡§Ç", selectDays: "‡§¶‡§ø‡§® ‡§ö‡•Å‡§®‡•á‡§Ç", selectLevel: "‡§∏‡•ç‡§§‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç",
      male: "‡§™‡•Å‡§∞‡•Å‡§∑", female: "‡§Æ‡§π‡§ø‡§≤‡§æ",
      fullGym: "‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ú‡§ø‡§Æ ‡§â‡§™‡§ï‡§∞‡§£", homeGym: "‡§π‡•ã‡§Æ ‡§ú‡§ø‡§Æ (‡§°‡§Æ‡•ç‡§¨‡§≤/‡§¨‡•à‡§Ç‡§°)",
      bodyweight: "‡§ï‡•á‡§µ‡§≤ ‡§∂‡§∞‡•Ä‡§∞ ‡§ï‡§æ ‡§µ‡§ú‡§®", minimal: "‡§®‡•ç‡§Ø‡•Ç‡§®‡§§‡§Æ ‡§â‡§™‡§ï‡§∞‡§£",
      weightLoss: "‡§µ‡§ú‡§® ‡§ï‡§Æ ‡§ï‡§∞‡§®‡§æ", muscleGain: "‡§Æ‡§æ‡§Ç‡§∏‡§™‡•á‡§∂‡•Ä ‡§¨‡§¢‡§º‡§æ‡§®‡§æ", strengthTraining: "‡§∂‡§ï‡•ç‡§§‡§ø ‡§™‡•ç‡§∞‡§∂‡§ø‡§ï‡•ç‡§∑‡§£",
      endurance: "‡§∏‡§π‡§®‡§∂‡•Ä‡§≤‡§§‡§æ", generalFitness: "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§´‡§ø‡§ü‡§®‡•á‡§∏", toning: "‡§ü‡•ã‡§®‡§ø‡§Ç‡§ó",
      oneDay: "‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§Æ‡•á‡§Ç 1 ‡§¶‡§ø‡§®", twoDays: "‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§Æ‡•á‡§Ç 2 ‡§¶‡§ø‡§®", threeDays: "‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§Æ‡•á‡§Ç 3 ‡§¶‡§ø‡§®",
      fourDays: "‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§Æ‡•á‡§Ç 4 ‡§¶‡§ø‡§®", fiveDays: "‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§Æ‡•á‡§Ç 5 ‡§¶‡§ø‡§®", sixDays: "‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§Æ‡•á‡§Ç 6 ‡§¶‡§ø‡§®", sevenDays: "‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§Æ‡•á‡§Ç 7 ‡§¶‡§ø‡§®",
      beginner: "‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§‡•Ä (0-6 ‡§Æ‡§π‡•Ä‡§®‡•á)", intermediate: "‡§Æ‡§ß‡•ç‡§Ø‡§Æ (6 ‡§Æ‡§π‡•Ä‡§®‡•á - 2 ‡§∏‡§æ‡§≤)", advanced: "‡§â‡§®‡•ç‡§®‡§§ (2+ ‡§∏‡§æ‡§≤)",
      workoutPlan: "üèãÔ∏è ‡§Ü‡§™‡§ï‡§æ ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§™‡•ç‡§≤‡§æ‡§®", client: "‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü", schedule: "‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä",
      goalAndLevel: "‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø ‡§î‡§∞ ‡§∏‡•ç‡§§‡§∞", heightWeight: "‡§≤‡§Ç‡§¨‡§æ‡§à ‡§î‡§∞ ‡§µ‡§ú‡§®", bmi: "‡§¨‡•Ä‡§è‡§Æ‡§Ü‡§à", equipment: "‡§â‡§™‡§ï‡§∞‡§£",
      selectWorkoutDay: "‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§¶‡§ø‡§® ‡§ö‡•Å‡§®‡•á‡§Ç:", safetyReminders: "üõ°Ô∏è ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§î‡§∞ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∞‡§ø‡§Æ‡§æ‡§á‡§Ç‡§°‡§∞",
      progressionPathway: "üìà ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§™‡§•", motivationEncouragement: "üí™ ‡§™‡•ç‡§∞‡•á‡§∞‡§£‡§æ ‡§î‡§∞ ‡§™‡•ç‡§∞‡•ã‡§§‡•ç‡§∏‡§æ‡§π‡§®",
      sets: "‡§∏‡•á‡§ü‡•ç‡§∏", reps: "‡§∞‡•á‡§™‡•ç‡§∏", rest: "‡§Ü‡§∞‡§æ‡§Æ", duration: "‡§Ö‡§µ‡§ß‡§ø",
      warmup: "‡§µ‡§æ‡§∞‡•ç‡§Æ‡§Ö‡§™", main: "‡§Æ‡•Å‡§ñ‡•ç‡§Ø", cooldown: "‡§ï‡•Ç‡§≤‡§°‡§æ‡§â‡§®",
      downloadPDF: "üìÑ ‡§™‡•Ä‡§°‡•Ä‡§è‡§´ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç", shareSummary: "üí¨ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç", sharePDFWhatsApp: "üìé ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§ê‡§™ ‡§™‡§∞ ‡§™‡•Ä‡§°‡•Ä‡§è‡§´ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç",
      shareYourPlan: "üì§ ‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§≤‡§æ‡§® ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç", shareDescription: "‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç, ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Ø‡§æ ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§ê‡§™ ‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§™‡•Ä‡§°‡•Ä‡§è‡§´ ‡§≠‡•á‡§ú‡•á‡§Ç",
      day: "‡§¶‡§ø‡§®", clientInformation: "‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä", name: "‡§®‡§æ‡§Æ", years: "‡§∏‡§æ‡§≤", cm: "‡§∏‡•á‡§Æ‡•Ä", kg: "‡§ï‡§ø‡§≤‡•ã",
      underweight: "‡§ï‡§Æ ‡§µ‡§ú‡§®", normal: "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø", overweight: "‡§Ö‡§ß‡§ø‡§ï ‡§µ‡§ú‡§®", obese: "‡§Æ‡•ã‡§ü‡§æ‡§™‡§æ",
      viewImage: "‡§õ‡§µ‡§ø ‡§¶‡•á‡§ñ‡•á‡§Ç", watchVideo: "‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§¶‡•á‡§ñ‡•á‡§Ç",
      basicDietPlan: "üçé ‡§Æ‡•Ç‡§≤ ‡§Ü‡§π‡§æ‡§∞ ‡§Ø‡•ã‡§ú‡§®‡§æ (‡§™‡•ã‡§∑‡§£)", vegetarian: "ü•¨ ‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä", nonVegetarian: "üçó ‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä", 
      breakfast: "‡§®‡§æ‡§∂‡•ç‡§§‡§æ", lunch: "‡§¶‡•ã‡§™‡§π‡§∞ ‡§ï‡§æ ‡§ñ‡§æ‡§®‡§æ", dinner: "‡§∞‡§æ‡§§ ‡§ï‡§æ ‡§ñ‡§æ‡§®‡§æ", snacks: "‡§∏‡•ç‡§®‡•à‡§ï‡•ç‡§∏",
      dailyCalories: "‡§¶‡•à‡§®‡§ø‡§ï ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø", nutritionTips: "‡§™‡•ã‡§∑‡§£ ‡§∏‡•Å‡§ù‡§æ‡§µ", calories: "‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä", protein: "‡§™‡•ç‡§∞‡•ã‡§ü‡•Ä‡§®"
    }
  };

  function clearError() { if (errorBox) { errorBox.classList.add('hidden'); errorText.textContent = ''; }}
  function showError(msg) { if (errorBox) { errorText.textContent = msg; errorBox.classList.remove('hidden'); } else console.warn(msg); }

  function escapeHtml(str) {
    if (str === undefined || str === null) return '';
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function getExerciseStyle(type) {
    switch (type) {
      case 'warmup': return 'bg-amber-700 border-l-4 border-amber-400';
      case 'main': return 'bg-emerald-700 border-l-4 border-emerald-400';
      case 'cooldown': return 'bg-blue-700 border-l-4 border-blue-400';
      default: return 'bg-gray-700 border-l-4 border-gray-400';
    }
  }

  function getDayNumber(dayKey) { 
    const dayNum = dayKey.replace('day', '');
    return currentLang === 'hi' ? `${labels[currentLang].day} ${dayNum}` : `Day ${dayNum}`;
  }

  function getTranslatedExerciseType(type) {
    switch (type) {
      case 'warmup': return labels[currentLang].warmup;
      case 'main': return labels[currentLang].main;
      case 'cooldown': return labels[currentLang].cooldown;
      default: return type.toUpperCase();
    }
  }


function renderExercisesHtml(exercises) {
  return exercises.map(ex => {
    // FIXED: Extract image and video URLs from new structure
    const imageUrl = ex.image ? ex.image.imageUrl : ex.imageUrl;
    const videoUrl = ex.video ? ex.video.videoUrl : ex.videoUrl;
    
    return `
      <div class="${getExerciseStyle(ex.type)} p-4 rounded-lg shadow-md">
        <div class="flex items-start justify-between mb-2">
          <h3 class="text-lg font-bold text-white">${escapeHtml(ex.name)}</h3>
          <span class="px-2 py-1 rounded-full text-xs font-medium ${ex.type==='warmup'?'bg-amber-500':ex.type==='main'?'bg-emerald-500':'bg-blue-500'} text-white">${getTranslatedExerciseType(ex.type)}</span>
        </div>
        ${ex.equipment ? `<p class="text-xs text-gray-400 mb-2">üèãÔ∏è ${labels[currentLang].equipment}: ${escapeHtml(ex.equipment)}</p>` : ''}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-2">
          ${ex.sets !== 'N/A' ? `<div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-xs text-gray-300">${labels[currentLang].sets}</p><p class="font-bold text-sm">${escapeHtml(ex.sets)}</p></div>` : ''}
          ${ex.reps !== 'N/A' ? `<div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-xs text-gray-300">${labels[currentLang].reps}</p><p class="font-bold text-sm">${escapeHtml(ex.reps)}</p></div>` : ''}
          ${ex.rest !== 'N/A' ? `<div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-xs text-gray-300">${labels[currentLang].rest}</p><p class="font-bold text-sm">${escapeHtml(ex.rest)}</p></div>` : ''}
          ${ex.duration !== 'N/A' ? `<div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-xs text-gray-300">${labels[currentLang].duration}</p><p class="font-bold text-sm">${escapeHtml(ex.duration)}</p></div>` : ''}
        </div>
        <p class="text-gray-200 leading-relaxed text-sm mb-3">${escapeHtml(ex.description)}</p>
        
        <!-- FIXED: Enhanced Image and Video URL Buttons -->
        ${(imageUrl || videoUrl) ? `
          <div class="exercise-url-buttons">
            ${imageUrl ? `<a href="${escapeHtml(imageUrl)}" target="_blank" class="url-btn image-btn">üì∑ ${labels[currentLang].viewImage}</a>` : ''}
            ${videoUrl ? `<a href="${escapeHtml(videoUrl)}" target="_blank" class="url-btn video-btn">üé• ${labels[currentLang].watchVideo}</a>` : ''}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');
}


  function showPlaceholder() {
    rightPanel.innerHTML = `
      <div class="text-center">
        <div class="mb-6">
          <div class="w-24 h-24 mx-auto bg-gray-700 rounded-full flex items-center justify-center mb-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.656 0 3-1.344 3-3S13.656 2 12 2s-3 1.344-3 3 1.344 3 3 3zM19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"/></svg>
          </div>
          <h2 class="text-2xl font-bold text-white mb-2">Ready to Get Fit?</h2>
          <p class="text-gray-400">Fill out the form to generate your personalized workout plan</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 max-w-md mx-auto">
          <div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-2xl mb-2">üéØ</div><p class="text-sm text-gray-300">Personalized Goals</p></div>
          <div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-2xl mb-2">‚ö°</div><p class="text-sm text-gray-300">Instant Generation</p></div>
          <div class="bg-gray-800 rounded-lg p-4 text-center"><div class="text-2xl mb-2">üìà</div><p class="text-sm text-gray-300">Progressive Plans</p></div>
        </div>
      </div>
    `;
  }


window.toggleNutritionType = function(type) {
  console.log(`üîÑ Switching nutrition from "${currentNutritionType}" to "${type}"`);
  
  // Update global variable
  currentNutritionType = type;

  // Update button visual states
  const vegBtn = document.getElementById('nutrition-veg-btn');
  const nonVegBtn = document.getElementById('nutrition-nonveg-btn');

  if (vegBtn && nonVegBtn) {
    // Remove active from both
    vegBtn.classList.remove('active');
    nonVegBtn.classList.remove('active');

    // Add active to selected
    if (type === 'vegetarian') {
      vegBtn.classList.add('active');
      console.log('‚úÖ ‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä tab activated');
    } else if (type === 'nonvegetarian') {
      nonVegBtn.classList.add('active');
      console.log('‚úÖ ‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä tab activated');
    }
  } else {
    console.error('‚ùå Nutrition buttons not found!');
  }

  // CRITICAL: Force update nutrition display
  if (currentWorkout && currentWorkout.nutritionPlan) {
    console.log('üçΩÔ∏è Updating nutrition display immediately...');
    updateNutritionDisplay();
    console.log('‚úÖ Nutrition display updated');
  } else {
    console.warn('‚ö†Ô∏è No nutrition plan available');
  }
};



function updateNutritionDisplay() {
  if (!currentWorkout || !currentWorkout.nutritionPlan) {
    console.log('‚ùå No workout or nutrition plan available for display');
    return;
  }

  console.log(`üîÑ Updating nutrition display for type: ${currentNutritionType}`);

  const nutritionData = currentWorkout.nutritionPlan;
  
  // Update calories
  const caloriesElement = document.getElementById('daily-calories');
  if (caloriesElement && nutritionData.dailyCalories) {
    caloriesElement.textContent = nutritionData.dailyCalories;
  }

  // Update all meal cards
  const meals = ['breakfast', 'lunch', 'dinner', 'snacks'];
  
  meals.forEach(meal => {
    if (nutritionData[meal]) {
      console.log(`üçΩÔ∏è Updating ${meal}...`);
      updateMealCard(meal, nutritionData[meal]);
    }
  });

  console.log(`‚úÖ All meals updated for ${currentNutritionType}`);
}

// Default calories for meal types
function getDefaultCalories(mealType) {
  const defaults = {
    breakfast: currentLang === 'hi' ? '400 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä' : '400 calories',
    lunch: currentLang === 'hi' ? '650 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä' : '650 calories', 
    dinner: currentLang === 'hi' ? '500 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä' : '500 calories',
    snacks: currentLang === 'hi' ? '200 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä' : '200 calories'
  };
  return defaults[mealType] || (currentLang === 'hi' ? '300 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä' : '300 calories');
}

// Default protein for meal types  
function getDefaultProtein(mealType) {
  const defaults = {
    breakfast: currentLang === 'hi' ? '20g ‡§™‡•ç‡§∞‡•ã‡§ü‡•Ä‡§®' : '20g protein',
    lunch: currentLang === 'hi' ? '30g ‡§™‡•ç‡§∞‡•ã‡§ü‡•Ä‡§®' : '30g protein',
    dinner: currentLang === 'hi' ? '25g ‡§™‡•ç‡§∞‡•ã‡§ü‡•Ä‡§®' : '25g protein', 
    snacks: currentLang === 'hi' ? '10g ‡§™‡•ç‡§∞‡•ã‡§ü‡•Ä‡§®' : '10g protein'
  };
  return defaults[mealType] || (currentLang === 'hi' ? '15g ‡§™‡•ç‡§∞‡•ã‡§ü‡•Ä‡§®' : '15g protein');
}


function updateMealCard(mealType, mealData) {
  const descriptionElement = document.getElementById(`${mealType}-description`);
  const caloriesElement = document.getElementById(`${mealType}-calories`);
  const proteinElement = document.getElementById(`${mealType}-protein`);

  if (!descriptionElement) {
    console.log(`‚ö†Ô∏è Meal card element not found: ${mealType}-description`);
    return;
  }

  console.log(`üçΩÔ∏è Processing ${mealType} for nutrition type: ${currentNutritionType}`);
  console.log(`üîç Raw meal data:`, mealData.substring(0, 150) + '...');

  let description = '';
  let calories = '';
  let protein = '';

  if (typeof mealData === 'string' && mealData.includes('|')) {
    // FIXED: Enhanced Hindi nutrition parsing
    const parts = mealData.split('|').map(part => part.trim());
    console.log(`üìã Split parts:`, parts);
    
    let selectedPart = '';

    if (currentNutritionType === 'vegetarian') {
      // Find ‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä part
      for (const part of parts) {
        if (part.includes('‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä:') || part.includes('VEGETARIAN:')) {
          selectedPart = part;
          break;
        }
      }
      
      // Remove prefix
      selectedPart = selectedPart.replace(/^(‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä:|VEGETARIAN:)\s*/, '').trim();
      
    } else if (currentNutritionType === 'nonvegetarian') {
      // Find ‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä part
      for (const part of parts) {
        if (part.includes('‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä:') || part.includes('NON-VEGETARIAN:')) {
          selectedPart = part;
          break;
        }
      }
      
      // Remove prefix
      selectedPart = selectedPart.replace(/^(‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä:|NON-VEGETARIAN:)\s*/, '').trim();
    }

    // Fallback if no specific type found
    if (!selectedPart) {
      selectedPart = parts[currentNutritionType === 'vegetarian' ? 0 : 1] || parts[0];
      selectedPart = selectedPart.replace(/^(‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä:|‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä:|VEGETARIAN:|NON-VEGETARIAN:)\s*/, '').trim();
    }

    console.log(`‚úÖ Selected part for ${mealType} (${currentNutritionType}):`, selectedPart);

    // Extract calories
    const calorieMatch = selectedPart.match(/\((\d+)\s*(‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä|calories)\)/i);
    if (calorieMatch) {
      calories = calorieMatch[1] + (currentLang === 'hi' ? ' ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä' : ' calories');
      description = selectedPart.replace(/\s*\(\d+\s*(‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä|calories)\)/i, '').trim();
      
      // Rough protein estimation
      const cal = parseInt(calorieMatch[1]);
      protein = Math.round(cal * 0.15 / 4) + (currentLang === 'hi' ? 'g ‡§™‡•ç‡§∞‡•ã‡§ü‡•Ä‡§®' : 'g protein');
    } else {
      description = selectedPart;
      calories = getDefaultCalories(mealType);
      protein = getDefaultProtein(mealType);
    }

  } else {
    // Single string without separator
    description = mealData.replace(/^(‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä:|‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä:|VEGETARIAN:|NON-VEGETARIAN:)\s*/, '').trim();
    calories = getDefaultCalories(mealType);
    protein = getDefaultProtein(mealType);
  }

  // Update DOM elements
  if (descriptionElement) descriptionElement.textContent = description;
  if (caloriesElement) caloriesElement.textContent = calories;
  if (proteinElement) proteinElement.textContent = protein;

  console.log(`üéØ Updated ${mealType}: "${description.substring(0, 50)}..."`);
}


  // NEW: Get default calories for meal types
  function getDefaultCalories(mealType) {
    const defaults = {
      breakfast: currentNutritionType === 'vegetarian' ? '300 ' + labels[currentLang].calories : '350 ' + labels[currentLang].calories,
      lunch: currentNutritionType === 'vegetarian' ? '600 ' + labels[currentLang].calories : '650 ' + labels[currentLang].calories,
      dinner: currentNutritionType === 'vegetarian' ? '500 ' + labels[currentLang].calories : '600 ' + labels[currentLang].calories,
      snacks: currentNutritionType === 'vegetarian' ? '150 ' + labels[currentLang].calories : '200 ' + labels[currentLang].calories
    };
    return defaults[mealType] || '300 ' + labels[currentLang].calories;
  }

  // NEW: Get default protein for meal types
  function getDefaultProtein(mealType) {
    const defaults = {
      breakfast: currentNutritionType === 'vegetarian' ? '12g ' + labels[currentLang].protein : '15g ' + labels[currentLang].protein,
      lunch: currentNutritionType === 'vegetarian' ? '25g ' + labels[currentLang].protein : '30g ' + labels[currentLang].protein,
      dinner: currentNutritionType === 'vegetarian' ? '18g ' + labels[currentLang].protein : '25g ' + labels[currentLang].protein,
      snacks: currentNutritionType === 'vegetarian' ? '6g ' + labels[currentLang].protein : '8g ' + labels[currentLang].protein
    };
    return defaults[mealType] || '10g ' + labels[currentLang].protein;
  }

  function getBMICategory(bmi) {
    const bmiValue = parseFloat(bmi);
    if (currentLang === 'hi') {
      if (bmiValue < 18.5) return labels[currentLang].underweight;
      if (bmiValue < 25) return labels[currentLang].normal;  
      if (bmiValue < 30) return labels[currentLang].overweight;
      return labels[currentLang].obese;
    } else {
      if (bmiValue < 18.5) return 'Underweight';
      if (bmiValue < 25) return 'Normal';  
      if (bmiValue < 30) return 'Overweight';
      return 'Obese';
    }
  }

  function renderWorkout(data) {
    currentWorkout = data;
    const dayKeys = Object.keys(data.workoutPlan);
    selectedDayKey = selectedDayKey || dayKeys[0];

    // Client Info Card
    let html = `
      <div class="bg-gradient-to-r from-blue-800 to-purple-800 rounded-xl p-4 mb-6 shadow-lg">
        <h1 class="text-xl font-bold mb-3 text-center">${labels[currentLang].workoutPlan}</h1>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="flex items-center gap-2 bg-white/10 rounded-lg p-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg><div><p class="text-xs text-gray-300">${labels[currentLang].client}</p><p class="font-semibold text-sm">${escapeHtml(data.clientInfo.name)}, ${escapeHtml(data.clientInfo.age)} ${labels[currentLang].years}</p></div></div>
          <div class="flex items-center gap-2 bg-white/10 rounded-lg p-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><div><p class="text-xs text-gray-300">${labels[currentLang].schedule}</p><p class="font-semibold text-sm">${escapeHtml(data.clientInfo.workoutDays)}</p></div></div>
          <div class="flex items-center gap-2 bg-white/10 rounded-lg p-3"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg><div><p class="text-xs text-gray-300">${labels[currentLang].goalAndLevel}</p><p class="font-semibold text-sm">${escapeHtml(data.clientInfo.goal)}</p><p class="text-xs text-gray-400">${escapeHtml(data.clientInfo.fitnessLevel)}</p></div></div>
          <div class="flex items-center gap-2 bg-white/10 rounded-lg p-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v18m9-9H3"/>
            </svg>
            <div>
              <p class="text-xs text-gray-300">${labels[currentLang].heightWeight}</p>
              <p class="font-semibold text-sm">${escapeHtml(data.clientInfo.height)} ${labels[currentLang].cm} / ${escapeHtml(data.clientInfo.weight)} ${labels[currentLang].kg}</p>
            </div>
          </div>

          <div class="flex items-center gap-2 bg-white/10 rounded-lg p-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01"/>
            </svg>
            <div>
              <p class="text-xs text-gray-300">${labels[currentLang].bmi}</p>
              <p class="font-semibold text-sm">${escapeHtml(data.clientInfo.bmi)} (${getBMICategory(data.clientInfo.bmi)})</p>
            </div>
          </div>

          <div class="flex items-center gap-2 bg-white/10 rounded-lg p-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
            </svg>
            <div>
              <p class="text-xs text-gray-300">${labels[currentLang].equipment}</p>
              <p class="font-semibold text-sm">${escapeHtml(data.clientInfo.equipment)}</p>
            </div>
          </div>
        </div>
      </div>
    `;

    // Day Selector
    html += `
      <div class="mb-4">
        <h2 class="text-lg font-semibold mb-2 text-white">${labels[currentLang].selectWorkoutDay}</h2>
        <div class="flex overflow-x-auto gap-2 pb-2">
          ${dayKeys.map(k => `<button data-day="${k}" class="day-btn px-4 py-2 rounded-lg whitespace-nowrap font-medium transition-all duration-200 text-sm ${selectedDayKey===k? 'active' : 'bg-gray-700 text-gray-300 hover:bg-gray-600 hover:text-white'}">${getDayNumber(k)}</button>`).join('')}
        </div>
      </div>
    `;

    // Current Day container
    const currentDay = data.workoutPlan[selectedDayKey];
    html += `
      <div class="bg-gray-800 rounded-xl p-4 mb-4 shadow-lg" id="current-day-card">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-2xl font-bold text-white">${escapeHtml(currentDay.title)}</h2>
          <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-medium">‚è±Ô∏è ${escapeHtml(currentDay.duration)}</span>
        </div>
        <div id="day-workout" class="space-y-3">
          ${renderExercisesHtml(currentDay.exercises)}
        </div>
      </div>
    `;

    // NEW: Enhanced Basic Diet Plans (Nutrition) Section
    html += `
      <div class="space-y-3">
        <!-- Enhanced Basic Diet Plans (Nutrition) Section -->
        ${data.nutritionPlan ? `
          <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg">
            <button data-toggle="nutrition" class="toggle-section w-full flex items-center justify-between p-3 bg-green-700 hover:bg-green-600 transition-colors">
              <span class="font-bold text-sm">${labels[currentLang].basicDietPlan}</span>
              <svg class="chev h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
            <div data-panel="nutrition" class="p-4 bg-gray-700" style="display:none">
              <!-- Daily Calories Display -->
              <div class="daily-calories">
                <span>üéØ ${labels[currentLang].dailyCalories}: </span>
                <span>${data.nutritionPlan.dailyCalories || '1800-2000 ' + labels[currentLang].calories}</span>
              </div>
              
              <!-- Vegetarian/Non-Vegetarian Toggle -->
              <div class="nutrition-toggle">
                <button id="nutrition-veg-btn" class="nutrition-toggle-btn active" onclick="window.toggleNutritionType('vegetarian')">
                  ${labels[currentLang].vegetarian}
                </button>
                <button id="nutrition-nonveg-btn" class="nutrition-toggle-btn" onclick="window.toggleNutritionType('nonvegetarian')">
                  ${labels[currentLang].nonVegetarian}
                </button>
              </div>
              
              <!-- Meals Container -->
              <div id="mealsContainer">
                <!-- Breakfast -->
                <div class="meal-card">
                  <div class="meal-header">
                    <div class="meal-icon">üåÖ</div>
                    <h4 class="meal-title">${labels[currentLang].breakfast}</h4>
                  </div>
                  <div class="meal-description" id="breakfast-description">
                    Loading...
                  </div>
                  <div class="meal-stats">
                    <span class="stat-item" id="breakfast-calories">300 ${labels[currentLang].calories}</span>
                    <span class="stat-item" id="breakfast-protein">12g ${labels[currentLang].protein}</span>
                  </div>
                </div>
                
                <!-- Lunch -->
                <div class="meal-card">
                  <div class="meal-header">
                    <div class="meal-icon">‚òÄÔ∏è</div>
                    <h4 class="meal-title">${labels[currentLang].lunch}</h4>
                  </div>
                  <div class="meal-description" id="lunch-description">
                    Loading...
                  </div>
                  <div class="meal-stats">
                    <span class="stat-item" id="lunch-calories">600 ${labels[currentLang].calories}</span>
                    <span class="stat-item" id="lunch-protein">25g ${labels[currentLang].protein}</span>
                  </div>
                </div>
                
                <!-- Dinner -->
                <div class="meal-card">
                  <div class="meal-header">
                    <div class="meal-icon">üåô</div>
                    <h4 class="meal-title">${labels[currentLang].dinner}</h4>
                  </div>
                  <div class="meal-description" id="dinner-description">
                    Loading...
                  </div>
                  <div class="meal-stats">
                    <span class="stat-item" id="dinner-calories">500 ${labels[currentLang].calories}</span>
                    <span class="stat-item" id="dinner-protein">18g ${labels[currentLang].protein}</span>
                  </div>
                </div>
                
                <!-- Snacks -->
                <div class="meal-card">
                  <div class="meal-header">
                    <div class="meal-icon">üçé</div>
                    <h4 class="meal-title">${labels[currentLang].snacks}</h4>
                  </div>
                  <div class="meal-description" id="snacks-description">
                    Loading...
                  </div>
                  <div class="meal-stats">
                    <span class="stat-item" id="snacks-calories">150 ${labels[currentLang].calories}</span>
                    <span class="stat-item" id="snacks-protein">6g ${labels[currentLang].protein}</span>
                  </div>
                </div>
              </div>
              
              <!-- Nutrition Tips -->
              <div class="nutrition-tips">
                <h4>
                  <span class="mr-2">üí°</span>
                  <span>${labels[currentLang].nutritionTips}</span>
                </h4>
                <ul>
                  ${data.nutritionPlan.nutritionTips ? data.nutritionPlan.nutritionTips.map(tip => `<li>${escapeHtml(tip)}</li>`).join('') : ''}
                </ul>
              </div>
            </div>
          </div>
        ` : ''}

        <!-- Safety Reminders Section -->
        <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg">
          <button data-toggle="safety" class="toggle-section w-full flex items-center justify-between p-3 bg-red-700 hover:bg-red-600 transition-colors"><span class="font-bold text-sm">${labels[currentLang].safetyReminders}</span><svg class="chev h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
          <div data-panel="safety" class="p-3 bg-gray-700" style="display:none"><ul class="space-y-1">${data.safetyReminders.map(t => `<li class="flex items-start gap-2"><span class="text-red-400 mt-1 text-xs">‚Ä¢</span><span class="text-gray-200 text-xs">${escapeHtml(t)}</span></li>`).join('')}</ul></div>
        </div>

        <!-- Progression Pathway Section -->
        <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg">
          <button data-toggle="progression" class="toggle-section w-full flex items-center justify-between p-3 bg-green-700 hover:bg-green-600 transition-colors"><span class="font-bold text-sm">${labels[currentLang].progressionPathway}</span><svg class="chev h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
          <div data-panel="progression" class="p-3 bg-gray-700" style="display:none"><ul class="space-y-1">${data.progressionPathway.map(t => `<li class="flex items-start gap-2"><span class="text-green-400 mt-1 text-xs">‚Ä¢</span><span class="text-gray-200 text-xs">${escapeHtml(t)}</span></li>`).join('')}</ul></div>
        </div>

        <!-- Motivation Section -->
        <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg">
          <button data-toggle="motivation" class="toggle-section w-full flex items-center justify-between p-3 bg-purple-700 hover:bg-purple-600 transition-colors"><span class="font-bold text-sm">${labels[currentLang].motivationEncouragement}</span><svg class="chev h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
          <div data-panel="motivation" class="p-3 bg-gray-700" style="display:none"><p class="text-gray-200 italic leading-relaxed text-sm">"${escapeHtml(data.motivation)}"</p></div>
        </div>
      </div>

      <!-- Action Buttons Section -->
      <div class="bg-gradient-to-r from-gray-800 to-gray-700 rounded-xl p-6 mt-6 shadow-lg border border-gray-600">
        <div class="text-center mb-4">
          <h3 class="text-lg font-bold text-white mb-2">${labels[currentLang].shareYourPlan}</h3>
          <p class="text-gray-400 text-sm">${labels[currentLang].shareDescription}</p>
        </div>
        <div class="action-buttons">
          <button id="download-pdf" class="action-btn pdf-btn">
            <span class="flex items-center justify-center gap-2">
              <strong>${labels[currentLang].downloadPDF}</strong>
            </span>
          </button>
          <button id="share-whatsapp" class="action-btn whatsapp-btn">
            <span class="flex items-center justify-center gap-2">
              <strong>${labels[currentLang].shareSummary}</strong>
            </span>
          </button>
          <button id="share-pdf-whatsapp" class="action-btn" style="background: linear-gradient(135deg, #128c7e, #25d366); color: white;">
            <span class="flex items-center justify-center gap-2">
              <strong>${labels[currentLang].sharePDFWhatsApp}</strong>
            </span>
          </button>
        </div>
        <div class="text-center mt-3">
          <p class="text-gray-500 text-xs">PDF Download ‚Ä¢ Quick Summary ‚Ä¢ PDF via WhatsApp</p>
        </div>
      </div>
    `;

    rightPanel.innerHTML = html;

    // Initialize nutrition content with current type
    if (data.nutritionPlan) {
      updateNutritionDisplay();
    }

    // Event listeners for day buttons with enhanced active state
    rightPanel.querySelectorAll('.day-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        selectedDayKey = btn.dataset.day;
        rightPanel.querySelectorAll('.day-btn').forEach(b => {
          b.classList.remove('active');
          b.classList.add('bg-gray-700','text-gray-300');
          b.classList.remove('bg-blue-600','text-white','shadow-lg','transform','scale-105');
        });
        btn.classList.add('active');
        btn.classList.remove('bg-gray-700','text-gray-300');
        const newDay = currentWorkout.workoutPlan[selectedDayKey];
        const card = document.getElementById('current-day-card');
        if (card) {
          card.querySelector('h2').textContent = newDay.title;
          card.querySelector('span').textContent = `‚è±Ô∏è ${newDay.duration}`;
          const dayWorkout = card.querySelector('#day-workout');
          dayWorkout.innerHTML = renderExercisesHtml(newDay.exercises);
        }
      });
    });

    // Event listeners for collapsible sections
    rightPanel.querySelectorAll('.toggle-section').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.getAttribute('data-toggle');
        const panel = rightPanel.querySelector(`[data-panel="${key}"]`);
        if (!panel) return;
        const isVisible = panel.style.display !== 'none';
        panel.style.display = isVisible ? 'none' : 'block';
        const chev = btn.querySelector('.chev'); 
        if (chev) chev.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(90deg)';
      });
    });

    // Event listeners for PDF and WhatsApp buttons
    const pdfBtn = document.getElementById('download-pdf');
    const whatsappBtn = document.getElementById('share-whatsapp');
    const pdfWhatsappBtn = document.getElementById('share-pdf-whatsapp');

    if (pdfBtn) pdfBtn.addEventListener('click', downloadPDF);
    if (whatsappBtn) whatsappBtn.addEventListener('click', shareOnWhatsApp);
    if (pdfWhatsappBtn) pdfWhatsappBtn.addEventListener('click', sharePDFOnWhatsApp);
  }

  // Enhanced PDF Generation with Nutrition
  function downloadPDF() {
    if (!currentWorkout) {
      alert('No workout plan available to download.');
      return;
    }

    const pdfBtn = document.getElementById('download-pdf');
    if (pdfBtn) {
      pdfBtn.disabled = true;
      pdfBtn.innerHTML = `<span class="pulse">${currentLang === 'hi' ? 'üìÑ ‡§™‡•Ä‡§°‡•Ä‡§è‡§´ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...' : 'üìÑ Generating PDF...'}</span>`;
    }

    try {
       if (currentLang === 'hi') {
      generateHindiPDF();
      return;
    }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Function to safely add text with proper encoding
      function addText(text, x, y, options = {}) {
        try {
          if (currentLang === 'hi') {
            const cleanText = String(text).replace(/[\u200B-\u200D\uFEFF]/g, '');
            doc.text(cleanText, x, y, options);
          } else {
            doc.text(String(text), x, y, options);
          }
        } catch (e) {
          console.warn('Text rendering issue:', e);
          const fallbackText = String(text).replace(/[^\x00-\x7F]/g, '?');
          doc.text(fallbackText, x, y, options);
        }
      }

      doc.setFont('helvetica');
      
      // Header
      doc.setFillColor(59, 130, 246);
      doc.rect(0, 0, 210, 25, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(20);
      const headerText = currentLang === 'hi' ? 'FitCoach Pro - ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§Ø‡•ã‡§ú‡§®‡§æ' : 'FitCoach Pro - Workout Plan';
      addText(headerText, 105, 15, { align: 'center' });
      
      // Client Information Section
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(14);
      let yPos = 35;
      
      doc.setFillColor(243, 244, 246);
      doc.rect(10, yPos - 5, 190, 50, 'F');
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      addText(labels[currentLang].clientInformation, 15, yPos);
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      yPos += 8;

      addText(`${labels[currentLang].name}: ${currentWorkout.clientInfo.name}`, 15, yPos);
      yPos += 4;
      addText(`${labels[currentLang].age}: ${currentWorkout.clientInfo.age} ${labels[currentLang].years}`, 15, yPos);
      yPos += 4;
      addText(`${labels[currentLang].gender}: ${currentWorkout.clientInfo.gender || 'N/A'}`, 15, yPos);
      yPos += 4;
      addText(`${labels[currentLang].goal}: ${currentWorkout.clientInfo.goal}`, 15, yPos);
      yPos += 4;
      addText(`${labels[currentLang].schedule}: ${currentWorkout.clientInfo.workoutDays}`, 15, yPos);
      yPos += 4;
      addText(`${labels[currentLang].fitnessLevel}: ${currentWorkout.clientInfo.fitnessLevel}`, 15, yPos);
      yPos += 4;
      addText(`${labels[currentLang].height}: ${currentWorkout.clientInfo.height || 'N/A'} ${labels[currentLang].cm}`, 15, yPos);
      yPos += 4;
      addText(`${labels[currentLang].weight}: ${currentWorkout.clientInfo.weight || 'N/A'} ${labels[currentLang].kg}`, 15, yPos);
      yPos += 4;
      addText(`${labels[currentLang].bmi}: ${currentWorkout.clientInfo.bmi || 'N/A'}`, 15, yPos);
      yPos += 4;
      addText(`${labels[currentLang].equipment}: ${currentWorkout.clientInfo.equipment || 'N/A'}`, 15, yPos);         
      yPos += 15;

      // Workout Plan Details with URLs
      const dayKeys = Object.keys(currentWorkout.workoutPlan);
      
      dayKeys.forEach((dayKey, dayIndex) => {
        if (yPos > 250) {
          doc.addPage();
          yPos = 20;
        }
        
        const day = currentWorkout.workoutPlan[dayKey];
        
        // Day Header
        doc.setFillColor(34, 197, 94);
        doc.rect(10, yPos - 3, 190, 12, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        addText(`${getDayNumber(dayKey).toUpperCase()}: ${day.title}`, 15, yPos + 4);
        addText(`${labels[currentLang].duration}: ${day.duration}`, 150, yPos + 4);
        
        yPos += 15;
        doc.setTextColor(0, 0, 0);
        
        // Exercises with URLs
        day.exercises.forEach((exercise, exIndex) => {
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }
          
          // Exercise header
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(10);
          addText(`${exIndex + 1}. ${exercise.name}`, 15, yPos);
          
          // Exercise type badge
          const typeColor = exercise.type === 'warmup' ? [245, 158, 11] : 
                           exercise.type === 'main' ? [34, 197, 94] : [59, 130, 246];
          doc.setFillColor(...typeColor);
          doc.rect(150, yPos - 3, 25, 6, 'F');
          doc.setTextColor(255, 255, 255);
          doc.setFontSize(8);
          addText(getTranslatedExerciseType(exercise.type), 162.5, yPos + 1, { align: 'center' });
          
          yPos += 8;
          doc.setTextColor(80, 80, 80);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          addText(`${labels[currentLang].equipment}: ${exercise.equipment || currentWorkout.clientInfo.equipment || 'N/A'}`, 15, yPos);
          yPos += 6;
          
          doc.setTextColor(0, 0, 0);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          
          // Exercise details
          const details = [];
          if (exercise.sets !== 'N/A') details.push(`${labels[currentLang].sets}: ${exercise.sets}`);
          if (exercise.reps !== 'N/A') details.push(`${labels[currentLang].reps}: ${exercise.reps}`);
          if (exercise.duration !== 'N/A') details.push(`${labels[currentLang].duration}: ${exercise.duration}`);
          if (exercise.rest !== 'N/A') details.push(`${labels[currentLang].rest}: ${exercise.rest}`);
          
          if (details.length > 0) {
            addText(details.join(' ‚Ä¢ '), 20, yPos);
            yPos += 5;
          }
          
        // Exercise description
const description = doc.splitTextToSize(exercise.description, 170);
description.forEach((line, index) => {
  if (yPos > 275) {
    doc.addPage();
    yPos = 20;
  }
  addText(line, 20, yPos);
  yPos += 4;
});

// ENHANCED: Add clickable exercise URLs to PDF
yPos += 2; // Small gap after description

// Get URLs from both old and new data structures
const imageUrl = exercise.image ? exercise.image.imageUrl : exercise.imageUrl;
const videoUrl = exercise.video ? exercise.video.videoUrl : exercise.videoUrl;

if (imageUrl || videoUrl) {
  yPos += 3;
  
  if (imageUrl) {
    if (yPos > 270) {
      doc.addPage();
      yPos = 20;
    }
    doc.setTextColor(59, 130, 246); // Blue color
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    
    // Add clickable link for image
    const imageText = `${labels[currentLang].viewImage}: ${imageUrl}`;
    addText(imageText, 20, yPos);
    
    // Make it clickable
    doc.link(20, yPos - 3, 170, 6, { url: imageUrl });
    yPos += 5;
  }
  
  if (videoUrl) {
    if (yPos > 270) {
      doc.addPage();
      yPos = 20;
    }
    doc.setTextColor(239, 68, 68); // Red color
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(8);
    
      // Add clickable link for video
    const videoText = `${labels[currentLang].watchVideo}: ${videoUrl}`;
    addText(videoText, 20, yPos);
    
    // Make it clickable
    doc.link(20, yPos - 3, 170, 6, { url: videoUrl });
    yPos += 5;
  }
  
  // Reset text color to black
  doc.setTextColor(0, 0, 0);
  doc.setFont('helvetica', 'normal');
}
yPos += 3; // Gap before next exercise
        });
        
        yPos += 5;
      });

      // Enhanced Nutrition Section in PDF
      if (currentWorkout.nutritionPlan) {
        if (yPos > 200) {
          doc.addPage();
          yPos = 20;
        }
        
        doc.setFillColor(34, 197, 94);
        doc.rect(10, yPos - 3, 190, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(11);
        addText(labels[currentLang].basicDietPlan, 15, yPos + 3);
        
        yPos += 15;
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);

        // Daily calories
        if (currentWorkout.nutritionPlan.dailyCalories) {
          doc.setFont('helvetica', 'bold');
          addText(`${labels[currentLang].dailyCalories}: ${currentWorkout.nutritionPlan.dailyCalories}`, 15, yPos);
          yPos += 8;
        }

        // Meals with both vegetarian and non-vegetarian options
        const meals = [
          { label: labels[currentLang].breakfast, content: currentWorkout.nutritionPlan.breakfast },
          { label: labels[currentLang].lunch, content: currentWorkout.nutritionPlan.lunch },
          { label: labels[currentLang].dinner, content: currentWorkout.nutritionPlan.dinner },
          { label: labels[currentLang].snacks, content: currentWorkout.nutritionPlan.snacks }
        ];

        meals.forEach(meal => {
          if (yPos > 260) {
            doc.addPage();
            yPos = 20;
          }
          doc.setFont('helvetica', 'bold');
          addText(`${meal.label}:`, 15, yPos);
          yPos += 5;
          doc.setFont('helvetica', 'normal');
          
          // Split vegetarian and non-vegetarian options
          if (meal.content && typeof meal.content === 'string') {
            const parts = meal.content.split('|');
            parts.forEach(part => {
              const trimmedPart = part.trim();
              if (trimmedPart) {
                const mealText = doc.splitTextToSize(trimmedPart, 180);
                mealText.forEach(line => {
                  if (yPos > 275) {
                    doc.addPage();
                    yPos = 20;
                  }
                  addText(line, 20, yPos);
                  yPos += 4;
                });
                yPos += 2;
              }
            });
          }
          yPos += 3;
        });

        // Nutrition tips
        if (currentWorkout.nutritionPlan.nutritionTips && currentWorkout.nutritionPlan.nutritionTips.length > 0) {
          if (yPos > 220) {
            doc.addPage();
            yPos = 20;
          }
          doc.setFont('helvetica', 'bold');
          addText(`${labels[currentLang].nutritionTips}:`, 15, yPos);
          yPos += 5;
          doc.setFont('helvetica', 'normal');
          
          currentWorkout.nutritionPlan.nutritionTips.forEach(tip => {
            if (yPos > 270) {
              doc.addPage();
              yPos = 20;
            }
            const tipText = doc.splitTextToSize(`‚Ä¢ ${tip}`, 180);
            tipText.forEach(line => {
              if (yPos > 275) {
                doc.addPage();
                yPos = 20;
              }
              addText(line, 15, yPos);
              yPos += 4;
            });
            yPos += 2;
          });
        }
      }

      // Safety Reminders
      if (yPos > 220) {
        doc.addPage();
        yPos = 20;
      }
      
      doc.setFillColor(239, 68, 68);
      doc.rect(10, yPos - 3, 190, 10, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      addText(labels[currentLang].safetyReminders, 15, yPos + 3);
      
      yPos += 12;
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      
      currentWorkout.safetyReminders.forEach((reminder, index) => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        const text = doc.splitTextToSize(`‚Ä¢ ${reminder}`, 180);
        text.forEach((line, lineIndex) => {
          if (yPos > 275) {
            doc.addPage();
            yPos = 20;
          }
          addText(line, 15, yPos);
          yPos += 4;
        });
        yPos += 2;
      });

      // Progression Pathway
      yPos += 5;
      if (yPos > 220) {
        doc.addPage();
        yPos = 20;
      }
      
      doc.setFillColor(34, 197, 94);
      doc.rect(10, yPos - 3, 190, 10, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      addText(labels[currentLang].progressionPathway, 15, yPos + 3);
      
      yPos += 12;
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      
      currentWorkout.progressionPathway.forEach((step, index) => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        const text = doc.splitTextToSize(`‚Ä¢ ${step}`, 180);
        text.forEach((line, lineIndex) => {
          if (yPos > 275) {
            doc.addPage();
            yPos = 20;
          }
          addText(line, 15, yPos);
          yPos += 4;
        });
        yPos += 2;
      });

      // Motivation
      yPos += 5;
      if (yPos > 250) {
        doc.addPage();
        yPos = 20;
      }
      
      doc.setFillColor(147, 51, 234);
      doc.rect(10, yPos - 3, 190, 10, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      addText(labels[currentLang].motivationEncouragement, 15, yPos + 3);
      
      yPos += 12;
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'italic');
      doc.setFontSize(10);
      const motivationText = doc.splitTextToSize(`"${currentWorkout.motivation}"`, 180);
      motivationText.forEach((line, index) => {
        if (yPos > 275) {
          doc.addPage();
          yPos = 20;
        }
        addText(line, 15, yPos);
        yPos += 4;
      });

      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(128, 128, 128);
        const footerText = currentLang === 'hi' ? 
          `FitCoach Pro ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‚Ä¢ ${new Date().toLocaleDateString()}` : 
          `Generated by FitCoach Pro ‚Ä¢ ${new Date().toLocaleDateString()}`;
        addText(footerText, 105, 290, { align: 'center' });
        const pageText = currentLang === 'hi' ? 
          `‡§™‡•É‡§∑‡•ç‡§† ${i} ‡§ï‡§æ ${pageCount}` : 
          `Page ${i} of ${pageCount}`;
        addText(pageText, 105, 295, { align: 'center' });
      }

      // Save the PDF
      const fileName = `FitCoach-${currentWorkout.clientInfo.name.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(fileName);
      
    } catch (error) {
      console.error('Error generating PDF:', error);
      alert('Error generating PDF. Please try again.');
    } finally {
      // Reset button
      setTimeout(() => {
        if (pdfBtn) {
          pdfBtn.disabled = false;
          pdfBtn.innerHTML = `<span class="flex items-center justify-center gap-2"><strong>${labels[currentLang].downloadPDF}</strong></span>`;
        }
      }, 2000);
    }
  }

  // ADD this function RIGHT AFTER your downloadPDF function
async function generateHindiPDF() {
  try {
    // Create a hidden div with Hindi content
    const tempDiv = document.createElement('div');
    tempDiv.style.cssText = `
      position: absolute;
      left: -9999px;
      top: 0;
      width: 800px;
      background: white;
      padding: 20px;
      font-family: 'Noto Sans Devanagari', Arial, sans-serif;
      font-size: 14px;
      line-height: 1.6;
      color: black;
    `;
    
    // Generate HTML content
    tempDiv.innerHTML = generateHindiHTMLContent();
    document.body.appendChild(tempDiv);
    
    // Wait for content to render
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Capture as image
    const canvas = await html2canvas(tempDiv, {
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff'
    });
    
    // Remove temp div
    document.body.removeChild(tempDiv);
    
    // Create PDF from image
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const imgWidth = 210;
    const pageHeight = 295;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    let heightLeft = imgHeight;
    let position = 0;
    
    doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;
    
    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      doc.addPage();
      doc.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }
    
    // Save PDF
    const fileName = `FitCoach-${currentWorkout.clientInfo.name.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    
  } catch (error) {
    console.error('Hindi PDF error:', error);
    alert('‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§™‡•Ä‡§°‡•Ä‡§è‡§´ ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§');
  }
}

// REPLACE your generateHindiHTMLContent() function with this FIXED version
function generateHindiHTMLContent() {
  let html = `
    <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #3B82F6; color: white; border-radius: 10px;">
      <h1 style="margin: 0; font-size: 20px;">FitCoach Pro - ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§Ø‡•ã‡§ú‡§®‡§æ</h1>
    </div>
    
    <div style="background: #F3F4F6; padding: 15px; border-radius: 8px; margin-bottom: 15px; page-break-inside: avoid;">
      <h2 style="color: #1F2937; margin-bottom: 10px; font-size: 16px;">‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h2>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
        <p style="margin: 2px 0;"><strong>‡§®‡§æ‡§Æ:</strong> ${currentWorkout.clientInfo.name}</p>
        <p style="margin: 2px 0;"><strong>‡§Ü‡§Ø‡•Å:</strong> ${currentWorkout.clientInfo.age} ‡§∏‡§æ‡§≤</p>
        <p style="margin: 2px 0;"><strong>‡§≤‡§ø‡§Ç‡§ó:</strong> ${currentWorkout.clientInfo.gender}</p>
        <p style="margin: 2px 0;"><strong>‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø:</strong> ${currentWorkout.clientInfo.goal}</p>
        <p style="margin: 2px 0;"><strong>‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä:</strong> ${currentWorkout.clientInfo.workoutDays}</p>
        <p style="margin: 2px 0;"><strong>‡§∏‡•ç‡§§‡§∞:</strong> ${currentWorkout.clientInfo.fitnessLevel}</p>
        <p style="margin: 2px 0;"><strong>‡§≤‡§Ç‡§¨‡§æ‡§à:</strong> ${currentWorkout.clientInfo.height} ‡§∏‡•á‡§Æ‡•Ä</p>
        <p style="margin: 2px 0;"><strong>‡§µ‡§ú‡§®:</strong> ${currentWorkout.clientInfo.weight} ‡§ï‡§ø‡§≤‡•ã</p>
        <p style="margin: 2px 0;"><strong>‡§¨‡•Ä‡§è‡§Æ‡§Ü‡§à:</strong> ${currentWorkout.clientInfo.bmi}</p>
        <p style="margin: 2px 0;"><strong>‡§â‡§™‡§ï‡§∞‡§£:</strong> ${currentWorkout.clientInfo.equipment}</p>
      </div>
    </div>
  `;
  
  // Add workout days with WORKING URLs
  const dayKeys = Object.keys(currentWorkout.workoutPlan);
  dayKeys.forEach((dayKey, index) => {
    const day = currentWorkout.workoutPlan[dayKey];
    html += `
      <div style="page-break-inside: avoid; margin-bottom: 20px; border: 2px solid #10B981; border-radius: 8px; overflow: hidden;">
        <div style="background: #10B981; color: white; padding: 10px; text-align: center;">
          <h3 style="margin: 0; font-size: 14px;">‡§¶‡§ø‡§® ${index + 1}: ${day.title}</h3>
          <p style="margin: 2px 0 0 0; font-size: 10px;">‡§Ö‡§µ‡§ß‡§ø: ${day.duration}</p>
        </div>
        <div style="padding: 12px;">
    `;
    
    // Enhanced exercise rendering with WORKING URLs
    day.exercises.forEach((exercise, exIndex) => {
      // Get exercise type in Hindi
      let exerciseTypeHindi = '';
      let typeBadgeColor = '';
      switch(exercise.type) {
        case 'warmup':
          exerciseTypeHindi = '‡§µ‡§æ‡§∞‡•ç‡§Æ‡§Ö‡§™';
          typeBadgeColor = '#F59E0B';
          break;
        case 'main':
          exerciseTypeHindi = '‡§Æ‡•Å‡§ñ‡•ç‡§Ø';
          typeBadgeColor = '#10B981';
          break;
        case 'cooldown':
          exerciseTypeHindi = '‡§ï‡•Ç‡§≤‡§°‡§æ‡§â‡§®';
          typeBadgeColor = '#3B82F6';
          break;
        default:
          exerciseTypeHindi = exercise.type || '';
          typeBadgeColor = '#6B7280';
      }

      // Get URLs from both old and new data structures
      const imageUrl = exercise.image ? exercise.image.imageUrl : exercise.imageUrl;
      const videoUrl = exercise.video ? exercise.video.videoUrl : exercise.videoUrl;

      html += `
        <div style="margin-bottom: 12px; padding: 10px; border-left: 3px solid #3B82F6; background: #F8FAFC; position: relative; page-break-inside: avoid;">
          <!-- Exercise Type Badge -->
          ${exerciseTypeHindi ? `<span style="position: absolute; top: 6px; right: 6px; background: ${typeBadgeColor}; color: white; padding: 3px 6px; border-radius: 3px; font-size: 9px; font-weight: bold;">${exerciseTypeHindi}</span>` : ''}
          
          <h4 style="margin: 0 0 6px 0; color: #1F2937; font-size: 12px; padding-right: 70px;">${exIndex + 1}. ${exercise.name}</h4>
          
          ${exercise.equipment ? `<p style="margin: 3px 0; font-size: 9px; color: #6B7280;"><strong>‡§â‡§™‡§ï‡§∞‡§£:</strong> ${exercise.equipment}</p>` : ''}
          
          <div style="display: flex; gap: 8px; margin: 6px 0; font-size: 9px; flex-wrap: wrap;">
            ${exercise.sets !== 'N/A' ? `<span style="background: rgba(59,130,246,0.1); padding: 3px 6px; border-radius: 3px;"><strong>‡§∏‡•á‡§ü‡•ç‡§∏:</strong> ${exercise.sets}</span>` : ''}
            ${exercise.reps !== 'N/A' ? `<span style="background: rgba(59,130,246,0.1); padding: 3px 6px; border-radius: 3px;"><strong>‡§∞‡•á‡§™‡•ç‡§∏:</strong> ${exercise.reps}</span>` : ''}
            ${exercise.duration !== 'N/A' ? `<span style="background: rgba(59,130,246,0.1); padding: 3px 6px; border-radius: 3px;"><strong>‡§Ö‡§µ‡§ß‡§ø:</strong> ${exercise.duration}</span>` : ''}
            ${exercise.rest !== 'N/A' ? `<span style="background: rgba(59,130,246,0.1); padding: 3px 6px; border-radius: 3px;"><strong>‡§Ü‡§∞‡§æ‡§Æ:</strong> ${exercise.rest}</span>` : ''}
          </div>
          
          <p style="margin: 6px 0; line-height: 1.3; font-size: 10px;">${exercise.description}</p>
          
          <!-- FIXED: Display actual URLs as text (since PDF can't have clickable links) -->
          ${(imageUrl || videoUrl) ? `
            <div style="margin-top: 8px; padding: 6px; background: #E5E7EB; border-radius: 4px; font-size: 8px;">
              <p style="margin: 0; font-weight: bold; color: #374151;">‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§≤‡§ø‡§Ç‡§ï:</p>
              ${imageUrl ? `<p style="margin: 2px 0; color: #3B82F6;"><strong>üì∑ ‡§õ‡§µ‡§ø URL:</strong> ${imageUrl}</p>` : ''}
              ${videoUrl ? `<p style="margin: 2px 0; color: #EF4444;"><strong>üé• ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã URL:</strong> ${videoUrl}</p>` : ''}
            </div>
          ` : ''}
        </div>
      `;
    });
    
    html += `</div></div>`;
  });
  
  // FIXED: Enhanced Nutrition Section with BOTH Vegetarian AND Non-Vegetarian
  if (currentWorkout.nutritionPlan) {
    html += `
      <div style="page-break-inside: avoid; margin-bottom: 20px; border: 2px solid #10B981; border-radius: 8px; overflow: hidden;">
        <div style="background: #10B981; color: white; padding: 12px; text-align: center;">
          <h3 style="margin: 0; font-size: 14px;">üçé ‡§Æ‡•Ç‡§≤ ‡§Ü‡§π‡§æ‡§∞ ‡§Ø‡•ã‡§ú‡§®‡§æ (‡§™‡•ã‡§∑‡§£)</h3>
        </div>
        <div style="padding: 15px;">
          <div style="text-align: center; background: linear-gradient(135deg, #F59E0B, #D97706); color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
            <strong style="font-size: 12px;">üéØ ‡§¶‡•à‡§®‡§ø‡§ï ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø: ${currentWorkout.nutritionPlan.dailyCalories || '1800-2000 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä'}</strong>
          </div>
    `;

    // FIXED: Process meals with BOTH vegetarian AND non-vegetarian options
    const meals = [
      { 
        hindi: '‡§®‡§æ‡§∂‡•ç‡§§‡§æ', 
        icon: 'üåÖ', 
        content: currentWorkout.nutritionPlan.breakfast
      },
      { 
        hindi: '‡§¶‡•ã‡§™‡§π‡§∞ ‡§ï‡§æ ‡§ñ‡§æ‡§®‡§æ', 
        icon: '‚òÄÔ∏è', 
        content: currentWorkout.nutritionPlan.lunch
      },
      { 
        hindi: '‡§∞‡§æ‡§§ ‡§ï‡§æ ‡§ñ‡§æ‡§®‡§æ', 
        icon: 'üåô', 
        content: currentWorkout.nutritionPlan.dinner
      },
      { 
        hindi: '‡§∏‡•ç‡§®‡•à‡§ï‡•ç‡§∏', 
        icon: 'üçé', 
        content: currentWorkout.nutritionPlan.snacks
      }
    ];

    meals.forEach(meal => {
      let vegDescription = '';
      let nonVegDescription = '';
      let vegCalories = '';
      let nonVegCalories = '';

      // FIXED: Process meal content for BOTH options
      if (meal.content && typeof meal.content === 'string') {
        if (meal.content.includes('|')) {
          const parts = meal.content.split('|').map(part => part.trim());
          
          // Process each part
          parts.forEach(part => {
            if (part.includes('‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä:') || part.includes('VEGETARIAN:')) {
              vegDescription = part.replace(/^(‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä:|VEGETARIAN:)\s*/, '');
              
              // Extract calories for veg
              const calorieMatch = vegDescription.match(/\((\d+)\s*(‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä|calories)\)/i);
              if (calorieMatch) {
                vegCalories = calorieMatch[1] + ' ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä';
                vegDescription = vegDescription.replace(/\s*\(\d+\s*(‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä|calories)\)/i, '');
              }
            }
            
            if (part.includes('‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä:') || part.includes('NON-VEGETARIAN:')) {
              nonVegDescription = part.replace(/^(‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä:|NON-VEGETARIAN:)\s*/, '');
              
              // Extract calories for non-veg
              const calorieMatch = nonVegDescription.match(/\((\d+)\s*(‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä|calories)\)/i);
              if (calorieMatch) {
                nonVegCalories = calorieMatch[1] + ' ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä';
                nonVegDescription = nonVegDescription.replace(/\s*\(\d+\s*(‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä|calories)\)/i, '');
              }
            }
          });
          
          // Fallback if no specific labels found
          if (!vegDescription && !nonVegDescription) {
            vegDescription = parts[0] || '';
            nonVegDescription = parts[1] || parts[0] || '';
          }
        } else {
          // Single content for both
          vegDescription = nonVegDescription = meal.content.replace(/^(‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä:|‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä:|VEGETARIAN:|NON-VEGETARIAN:)\s*/, '');
        }
      }

      // Set default calories if not found
      if (!vegCalories) vegCalories = getDefaultCalories(meal.hindi, 'veg');
      if (!nonVegCalories) nonVegCalories = getDefaultCalories(meal.hindi, 'non-veg');

      html += `
        <div style="margin-bottom: 15px; page-break-inside: avoid;">
          <div style="background: #1F2937; color: white; padding: 10px; border-radius: 8px 8px 0 0;">
            <h4 style="margin: 0; font-size: 12px; display: flex; align-items: center;">
              <span style="margin-right: 8px;">${meal.icon}</span>
              ${meal.hindi}
            </h4>
          </div>
          
          <!-- Vegetarian Option -->
          <div style="background: #F0FDF4; border: 1px solid #10B981; border-top: none; padding: 10px;">
            <div style="display: flex; align-items: center; margin-bottom: 6px;">
              <span style="background: #10B981; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; margin-right: 8px;">ü•¨ ‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä</span>
              <span style="background: rgba(16,185,129,0.2); color: #10B981; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold;">${vegCalories}</span>
            </div>
            <p style="margin: 0; color: #065F46; font-size: 10px; line-height: 1.3;">${vegDescription || '‡§∂‡§æ‡§ï‡§æ‡§π‡§æ‡§∞‡•Ä ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß'}</p>
          </div>
          
          <!-- Non-Vegetarian Option -->
          <div style="background: #FEF2F2; border: 1px solid #EF4444; border-top: none; padding: 10px; border-radius: 0 0 8px 8px;">
            <div style="display: flex; align-items: center; margin-bottom: 6px;">
              <span style="background: #EF4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold; margin-right: 8px;">üçó ‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä</span>
              <span style="background: rgba(239,68,68,0.2); color: #EF4444; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: bold;">${nonVegCalories}</span>
            </div>
            <p style="margin: 0; color: #7F1D1D; font-size: 10px; line-height: 1.3;">${nonVegDescription || '‡§Æ‡§æ‡§Ç‡§∏‡§æ‡§π‡§æ‡§∞‡•Ä ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß'}</p>
          </div>
        </div>
      `;
    });

    // Add nutrition tips
    if (currentWorkout.nutritionPlan.nutritionTips && currentWorkout.nutritionPlan.nutritionTips.length > 0) {
      html += `
        <div style="background: linear-gradient(135deg, #7C3AED, #5B21B6); border-radius: 8px; padding: 12px; margin-top: 15px; page-break-inside: avoid;">
          <h4 style="color: white; font-size: 12px; font-weight: bold; margin-bottom: 8px;">üí° ‡§™‡•ã‡§∑‡§£ ‡§∏‡•Å‡§ù‡§æ‡§µ</h4>
          <ul style="list-style: none; padding: 0; margin: 0;">
      `;
      
      currentWorkout.nutritionPlan.nutritionTips.forEach(tip => {
        html += `<li style="color: #E5E7EB; padding: 4px 0; font-size: 9px; line-height: 1.3;">‚Ä¢ ${tip}</li>`;
      });
      
      html += `</ul></div>`;
    }

    html += `</div></div>`;
  }

  // Add other sections with better spacing
  // Safety Reminders
  if (currentWorkout.safetyReminders && currentWorkout.safetyReminders.length > 0) {
    html += `
      <div style="page-break-inside: avoid; margin-bottom: 20px; border: 2px solid #EF4444; border-radius: 8px; overflow: hidden;">
        <div style="background: #EF4444; color: white; padding: 10px; text-align: center;">
          <h3 style="margin: 0; font-size: 12px;">üõ°Ô∏è ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§î‡§∞ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∞‡§ø‡§Æ‡§æ‡§á‡§Ç‡§°‡§∞</h3>
        </div>
        <div style="padding: 12px;">
          <ul style="list-style: none; padding: 0; margin: 0;">
    `;
    
    currentWorkout.safetyReminders.forEach(reminder => {
      html += `<li style="margin-bottom: 6px; padding: 6px; background: #FEF2F2; border-left: 3px solid #EF4444; font-size: 9px; line-height: 1.3;">‚Ä¢ ${reminder}</li>`;
    });
    
    html += `</ul></div></div>`;
  }

  // Progression Pathway
  if (currentWorkout.progressionPathway && currentWorkout.progressionPathway.length > 0) {
    html += `
      <div style="page-break-inside: avoid; margin-bottom: 20px; border: 2px solid #10B981; border-radius: 8px; overflow: hidden;">
        <div style="background: #10B981; color: white; padding: 10px; text-align: center;">
          <h3 style="margin: 0; font-size: 12px;">üìà ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§™‡§•</h3>
        </div>
        <div style="padding: 12px;">
          <ul style="list-style: none; padding: 0; margin: 0;">
    `;
    
    currentWorkout.progressionPathway.forEach(step => {
      html += `<li style="margin-bottom: 6px; padding: 6px; background: #F0FDF4; border-left: 3px solid #10B981; font-size: 9px; line-height: 1.3;">‚Ä¢ ${step}</li>`;
    });
    
    html += `</ul></div></div>`;
  }

  // Motivation Section
  if (currentWorkout.motivation) {
    html += `
      <div style="page-break-inside: avoid; margin-bottom: 20px; border: 2px solid #8B5CF6; border-radius: 8px; overflow: hidden;">
        <div style="background: #8B5CF6; color: white; padding: 10px; text-align: center;">
          <h3 style="margin: 0; font-size: 12px;">üí™ ‡§™‡•ç‡§∞‡•á‡§∞‡§£‡§æ ‡§î‡§∞ ‡§™‡•ç‡§∞‡•ã‡§§‡•ç‡§∏‡§æ‡§π‡§®</h3>
        </div>
        <div style="padding: 12px;">
          <blockquote style="margin: 0; padding: 10px; background: #FAF5FF; border-left: 4px solid #8B5CF6; font-style: italic; font-size: 10px; line-height: 1.4; color: #4C1D95;">
            "${currentWorkout.motivation}"
          </blockquote>
        </div>
      </div>
    `;
  }
  
  return html;
}

// Helper function for default calories
function getDefaultCalories(mealType, dietType) {
  const defaults = {
    '‡§®‡§æ‡§∂‡•ç‡§§‡§æ': { veg: '300 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä', 'non-veg': '350 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä' },
    '‡§¶‡•ã‡§™‡§π‡§∞ ‡§ï‡§æ ‡§ñ‡§æ‡§®‡§æ': { veg: '600 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä', 'non-veg': '650 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä' },
    '‡§∞‡§æ‡§§ ‡§ï‡§æ ‡§ñ‡§æ‡§®‡§æ': { veg: '500 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä', 'non-veg': '550 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä' },
    '‡§∏‡•ç‡§®‡•à‡§ï‡•ç‡§∏': { veg: '150 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä', 'non-veg': '200 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä' }
  };
  
  return defaults[mealType]?.[dietType] || '300 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä';
}

  // WhatsApp Summary Share
  function shareOnWhatsApp() {
    if (!currentWorkout) {
      alert('No workout plan available to share.');
      return;
    }

    let shareText = currentLang === 'hi' ? 
      `üèãÔ∏è *‡§Æ‡•á‡§∞‡•Ä ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§Ø‡•ã‡§ú‡§®‡§æ*\n\n` +
      `üë§ *‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü:* ${currentWorkout.clientInfo.name}\n` +
      `üéØ *‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø:* ${currentWorkout.clientInfo.goal}\n` +
      `üìÖ *‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä:* ${currentWorkout.clientInfo.workoutDays}\n` +
      `üí™ *‡§∏‡•ç‡§§‡§∞:* ${currentWorkout.clientInfo.fitnessLevel}\n\n` :
      `üèãÔ∏è *MY PERSONALIZED WORKOUT PLAN*\n\n` +
      `üë§ *Client:* ${currentWorkout.clientInfo.name}\n` +
      `üéØ *Goal:* ${currentWorkout.clientInfo.goal}\n` +
      `üìÖ *Schedule:* ${currentWorkout.clientInfo.workoutDays}\n` +
      `üí™ *Level:* ${currentWorkout.clientInfo.fitnessLevel}\n\n`;

    // Add nutrition summary if available
    if (currentWorkout.nutritionPlan) {
      shareText += currentLang === 'hi' ? 
        `üçé *‡§™‡•ã‡§∑‡§£ ‡§Ø‡•ã‡§ú‡§®‡§æ:* ${currentWorkout.nutritionPlan.dailyCalories || '1800-2000 ‡§ï‡•à‡§≤‡•ã‡§∞‡•Ä'}\n\n` :
        `üçé *Nutrition Plan:* ${currentWorkout.nutritionPlan.dailyCalories || '1800-2000 calories'}\n\n`;
    }

    shareText += currentLang === 'hi' ? 
      `‚ú® *FitCoach Pro ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞*` : 
      `‚ú® *Generated by FitCoach Pro*`;

    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
    window.open(whatsappUrl, '_blank');
  }

  // WhatsApp PDF Share
  async function sharePDFOnWhatsApp() {
    if (!currentWorkout) {
      alert('No workout plan available to share.');
      return;
    }

    const pdfWhatsappBtn = document.getElementById('share-pdf-whatsapp');
    if (pdfWhatsappBtn) {
      pdfWhatsappBtn.disabled = true;
      pdfWhatsappBtn.innerHTML = `<span class="pulse">${currentLang === 'hi' ? 'üì± ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§ê‡§™ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡•Ä‡§°‡•Ä‡§è‡§´ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...' : 'üì± Generating PDF for WhatsApp...'}</span>`;
    }

    try {
      // First download the PDF
      downloadPDF();
      
      // Prepare WhatsApp message
      const shareText = currentLang === 'hi' ? 
        `üèãÔ∏è‚Äç‚ôÄÔ∏è *‡§Æ‡•á‡§∞‡•Ä ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§Ø‡•ã‡§ú‡§®‡§æ*\n\n` +
        `üë§ *‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü:* ${currentWorkout.clientInfo.name}\n` +
        `üéØ *‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø:* ${currentWorkout.clientInfo.goal}\n` +
        `üìÖ *‡§Ö‡§®‡•Å‡§∏‡•Ç‡§ö‡•Ä:* ${currentWorkout.clientInfo.workoutDays}\n\n` +
        `üìé ‡§Æ‡•à‡§Ç‡§®‡•á ‡§™‡•Ç‡§∞‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§™‡•Ä‡§°‡•Ä‡§è‡§´ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡•Ä ‡§π‡•à‡•§ ` +
        `‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§≠‡•Ä ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§µ‡§ø‡§µ‡§∞‡§£, ‡§™‡•ã‡§∑‡§£ ‡§Ø‡•ã‡§ú‡§®‡§æ, ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§ü‡§ø‡§™‡•ç‡§∏ ‡§î‡§∞ ‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§ó‡§æ‡§á‡§° ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§Ç‡§≤‡§ó‡•ç‡§® ‡§´‡§º‡§æ‡§á‡§≤ ‡§ñ‡•ã‡§ú‡•á‡§Ç!\n\n` +
        `‚ú® *FitCoach Pro ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§§‡•à‡§Ø‡§æ‡§∞*` :
        `üèãÔ∏è‚Äç‚ôÄÔ∏è *MY PERSONALIZED WORKOUT PLAN*\n\n` +
        `üë§ *Client:* ${currentWorkout.clientInfo.name}\n` +
        `üéØ *Goal:* ${currentWorkout.clientInfo.goal}\n` +
        `üìÖ *Schedule:* ${currentWorkout.clientInfo.workoutDays}\n\n` +
        `üìé I've downloaded the complete workout plan PDF. ` +
        `Please find the attached file with all exercise details, nutrition plan, safety tips, and progression guide!\n\n` +
        `‚ú® *Generated by FitCoach Pro*`;
      
      setTimeout(() => {
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
        window.open(whatsappUrl, '_blank');
        showPDFShareInstructions();
      }, 1000);
      
    } catch (error) {
      console.error('Error sharing PDF to WhatsApp:', error);
      alert('Error preparing PDF for WhatsApp. Please try again.');
    } finally {
      setTimeout(() => {
        if (pdfWhatsappBtn) {
          pdfWhatsappBtn.disabled = false;
          pdfWhatsappBtn.innerHTML = `<span class="flex items-center justify-center gap-2"><strong>${labels[currentLang].sharePDFWhatsApp}</strong></span>`;
        }
      }, 2000);
    }
  }

  // PDF Share Instructions Modal
  function showPDFShareInstructions() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
      align-items: center; justify-content: center;
    `;
    
    const instructions = currentLang === 'hi' ? {
      title: 'üìé ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§™‡§∞ ‡§™‡•Ä‡§°‡•Ä‡§è‡§´ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç',
      step1: '‡§ö‡§∞‡§£ 1: ‡§Ü‡§™‡§ï‡§æ ‡§™‡•Ä‡§°‡•Ä‡§è‡§´ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§π‡•ã ‡§ó‡§Ø‡§æ ‡§π‡•à ‚úì',
      step2: '‡§ö‡§∞‡§£ 2: ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§ñ‡•Å‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à ‚úì',
      step3: '‡§ö‡§∞‡§£ 3: ‡§Ö‡§ü‡•à‡§ö‡§Æ‡•á‡§Ç‡§ü (üìé) ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç',
      step4: '‡§ö‡§∞‡§£ 4: "‡§°‡•â‡§ï‡•ç‡§Ø‡•Ç‡§Æ‡•á‡§Ç‡§ü" ‡§ö‡•Å‡§®‡•á‡§Ç ‡§î‡§∞ ‡§Ö‡§™‡§®‡§æ ‡§™‡•Ä‡§°‡•Ä‡§è‡§´ ‡§ö‡•Å‡§®‡•á‡§Ç',
      step5: '‡§ö‡§∞‡§£ 5: ‡§Ö‡§™‡§®‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡•ã ‡§≠‡•á‡§ú‡•á‡§Ç! üöÄ',
      gotIt: '‡§∏‡§Æ‡§ù ‡§ó‡§Ø‡§æ! üëç'
    } : {
      title: 'üìé Share PDF on WhatsApp',
      step1: 'Step 1: Your PDF has been downloaded ‚úì',
      step2: 'Step 2: WhatsApp is opening ‚úì',
      step3: 'Step 3: Click the attachment (üìé) button',
      step4: 'Step 4: Select "Document" and choose your PDF',
      step5: 'Step 5: Send to your contact! üöÄ',
      gotIt: 'Got it! üëç'
    };
    
    modal.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; text-align: center; margin: 20px;">
        <h3 style="color: #333; margin-bottom: 15px; font-size: 18px;">${instructions.title}</h3>
        <div style="color: #666; margin-bottom: 20px; line-height: 1.6; text-align: left;">
          <p><strong>${instructions.step1}</strong></p>
          <p><strong>${instructions.step2}</strong></p>
          <p><strong>${instructions.step3}</strong></p>
          <p><strong>${instructions.step4}</strong></p>
          <p><strong>${instructions.step5}</strong></p>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" 
                style="background: #25d366; color: white; border: none; padding: 12px 24px; 
                       border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px;">
          ${instructions.gotIt}
        </button>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Auto-remove after 10 seconds
    setTimeout(() => {
      if (modal.parentElement) modal.remove();
    }, 10000);
  }

  function setLoading(isLoading) {
    if (!generateBtn) return;
    generateBtn.disabled = isLoading;
    if (isLoading) {
      generateText.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Generating...</span>';
    } else {
      generateText.textContent = labels[currentLang].generate;
    }
  }


// REPLACE WITH:
async function handleSubmit(ev) {
  ev.preventDefault();
  clearError();

    // NEW: Check if user has free plans left BEFORE processing
  if (currentUser && userProfile) {
    if (userProfile.subscription_plan === 'free' && userProfile.plans_generated >= userProfile.plans_limit) {
      console.log("Free plans exhausted - showing upgrade modal");
      showUpgradeModal();
      return; // Stop the form submission
    }
  }

  if (!form.checkValidity()) {
    showError('Please fill in all required fields.');
    return;
  }

  const body = {
    Client: form.Client.value.trim(),
    Age: form.Age.value.trim(),
    Height: form.height.value,                    
    Weight: form.weight.value,                    
    BMI: calculateBMIValue(),
    Gender: form.Gender.value,
    Goal: form.Goal.value,
    WorkoutDays: form.WorkoutDays.value,
    FitnessLevel: form.FitnessLevel.value,
    Equipment: form.equipment.value,
    Language: currentLang, // Send current language to backend
    IncludeNutrition: true,
    IncludeExerciseURLs: true
  };

  console.log('Sending data to webhook with language:', currentLang, body);
  setLoading(true);
  showExtendedLoadingMessage();

  try {
    // ENHANCED: Extended timeout for Hindi processing
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 600000); // 10 minutes for Hindi

    const res = await fetch(WEBHOOK_URL, {
  method: 'POST',
  mode: 'cors',
  headers: { 
    'Content-Type': 'application/json; charset=utf-8',
    'Accept': 'application/json',
    'Accept-Charset': 'utf-8',
    'Access-Control-Request-Headers': 'Content-Type'
  },
  body: JSON.stringify(body, null, 0),
  signal: controller.signal
});

    clearTimeout(timeoutId);

    console.log('‚úÖ Webhook response status:', res.status);

    if (!res.ok) {
      throw new Error(`Server responded with ${res.status}: ${res.statusText}`);
    }

    // ENHANCED: Hindi content parsing
    const responseText = await res.text();
    console.log('Raw response length:', responseText.length);
    console.log('Response preview:', responseText.substring(0, 200));

    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('JSON Parse Error:', parseError);
      throw new Error('Invalid JSON response from server');
    }

    console.log('‚úÖ Parsed response:', data);

    // Process real backend data
    let payload = Array.isArray(data) ? data[0] : data;

    if (!payload || !payload.workoutPlan) {
      throw new Error('Invalid workout plan received from server');
    }

    // ENHANCED: Hindi content validation
    console.log('Client info received:', payload.clientInfo);
    console.log('Workout plan keys:', Object.keys(payload.workoutPlan));

    // Merge client info if missing
    payload.clientInfo = payload.clientInfo || {};
    payload.clientInfo.name = payload.clientInfo.name || body.Client;
    payload.clientInfo.age = payload.clientInfo.age || body.Age;
    payload.clientInfo.height = payload.clientInfo.height || body.Height;
    payload.clientInfo.weight = payload.clientInfo.weight || body.Weight;
    payload.clientInfo.bmi = payload.clientInfo.bmi || body.BMI;
    payload.clientInfo.goal = payload.clientInfo.goal || body.Goal;
    payload.clientInfo.workoutDays = payload.clientInfo.workoutDays || body.WorkoutDays;
    payload.clientInfo.fitnessLevel = payload.clientInfo.fitnessLevel || body.FitnessLevel;
    payload.clientInfo.gender = payload.clientInfo.gender || body.Gender;
    payload.clientInfo.equipment = payload.clientInfo.equipment || body.Equipment;

    selectedDayKey = Object.keys(payload.workoutPlan)[0];
    
    // ENHANCED: Display Hindi content
    console.log('üéØ Rendering workout with language:', currentLang);
    renderWorkout(payload);

    // NEW: Double-check before saving and incrementing
const canGenerate = await incrementPlanCount(body.Client, payload);
if (!canGenerate) {
    console.log("Plan generation blocked due to limits");
    showUpgradeModal();
    return;
}
    
    // Success message in appropriate language
    const successMsg = currentLang === 'hi' ? 
      '‚úÖ ‡§Ü‡§™‡§ï‡§æ ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§™‡•ç‡§≤‡§æ‡§® ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•ã ‡§ó‡§Ø‡§æ!' : 
      '‚úÖ Your workout plan has been generated successfully!';
    showSuccess(successMsg);
    
  } catch (err) {
    console.error('‚ùå Webhook error:', err);
    
    let errorMessage = '';
    if (err.name === 'AbortError') {
      errorMessage = currentLang === 'hi' ? 
        '‚è∞ ‡§¨‡•à‡§ï‡§è‡§Ç‡§° ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§Ø ‡§≤‡§ó ‡§∞‡§π‡§æ ‡§π‡•à (5+ ‡§Æ‡§ø‡§®‡§ü)‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§' :
        '‚è∞ Backend processing is taking longer than expected (>5 minutes). Please try again.';
    } else if (err.message.includes('CORS') || err.message.includes('fetch')) {
      errorMessage = currentLang === 'hi' ? 
        'üåê ‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§è‡§∞‡§∞: ‡§¨‡•à‡§ï‡§è‡§Ç‡§° ‡§∏‡•á ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ ‡§∞‡§π‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§' :
        'üåê Network error: Unable to connect to backend. Please check your connection.';
    } else {
      errorMessage = currentLang === 'hi' ? 
        `‚ùå ‡§¨‡•à‡§ï‡§è‡§Ç‡§° ‡§è‡§∞‡§∞: ${err.message}‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§` :
        `‚ùå Backend error: ${err.message}. Please try again.`;
    }
    
    showError(errorMessage);
    
  } finally {
    setLoading(false);
    hideExtendedLoadingMessage();
  }
}


// REPLACE WITH:
function showExtendedLoadingMessage() {
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'extended-loading';
  loadingDiv.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-80 z-50 flex items-center justify-center';
  
  const isHindi = currentLang === 'hi';
  
  loadingDiv.innerHTML = `
    <div class="bg-gray-800 p-8 rounded-xl text-center max-w-md mx-4">
      <div class="animate-spin w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
      <h3 class="text-white text-xl font-bold mb-2">
        ${isHindi ? 'ü§ñ AI ‡§ï‡§æ‡§Æ ‡§ï‡§∞ ‡§∞‡§π‡§æ ‡§π‡•à!' : 'ü§ñ AI is Working Hard!'}
      </h3>
      <p class="text-gray-300 mb-4">
        ${isHindi ? '‡§Ü‡§™‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø‡§ó‡§§ ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§™‡•ç‡§≤‡§æ‡§® ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...' : 'Creating your personalized workout plan...'}
      </p>
      <div class="bg-gray-700 rounded-lg p-4">
        <p class="text-sm text-yellow-300 mb-2">
          ${isHindi ? '‚è∞ ‡§á‡§∏‡§Æ‡•á‡§Ç 5 ‡§Æ‡§ø‡§®‡§ü ‡§§‡§ï ‡§∏‡§Æ‡§Ø ‡§≤‡§ó ‡§∏‡§ï‡§§‡§æ ‡§π‡•à' : '‚è∞ This may take up to 5 minutes'}
        </p>
        <div class="text-xs text-gray-400 space-y-1">
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span>${isHindi ? '‡§Ü‡§™‡§ï‡•Ä ‡§´‡§ø‡§ü‡§®‡•á‡§∏ ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£' : 'Analyzing your fitness profile'}</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
            <span>${isHindi ? '‡§ï‡§∏‡•ç‡§ü‡§Æ ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç' : 'Generating custom exercises'}</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
            <span>${isHindi ? '‡§™‡•ã‡§∑‡§£ ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§¨‡§®‡§æ ‡§∞‡§π‡•á ‡§π‡•à‡§Ç' : 'Creating nutrition plan'}</span>
          </div>
        </div>
      </div>
      <p class="text-gray-400 text-xs mt-4">
        ${isHindi ? '‡§ï‡•É‡§™‡§Ø‡§æ ‡§á‡§∏ ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ï‡•ã ‡§¨‡§Ç‡§¶ ‡§® ‡§ï‡§∞‡•á‡§Ç' : 'Please don\'t close this window'}
      </p>
    </div>
  `;
  
  document.body.appendChild(loadingDiv);
}


function hideExtendedLoadingMessage() {
  const loadingDiv = document.getElementById('extended-loading');
  if (loadingDiv) {
    loadingDiv.remove();
  }
}

// ADD THIS NEW FUNCTION:
function showSuccess(message) {
  const successDiv = document.createElement('div');
  successDiv.className = 'fixed top-4 right-4 bg-green-600 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
  successDiv.innerHTML = `
    <div class="flex items-start gap-3">
      <svg class="w-6 h-6 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div>
        <p class="font-medium">${message}</p>
        <p class="text-sm text-green-100 mt-1">
          ${currentLang === 'hi' ? '‡§Ü‡§™‡§ï‡§æ ‡§™‡•ç‡§≤‡§æ‡§® ‡§§‡•à‡§Ø‡§æ‡§∞ ‡§π‡•à!' : 'Your plan is ready!'}
        </p>
      </div>
    </div>
  `;
  
  document.body.appendChild(successDiv);
  
  setTimeout(() => {
    successDiv.remove();
  }, 5000);
}


// UPDATED: Enhanced setLoading function
function setLoading(isLoading) {
  if (!generateBtn) return;
  generateBtn.disabled = isLoading;
  
  if (isLoading) {
    generateText.innerHTML = `
      <span class="flex items-center justify-center">
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Generating... (up to 3 min)
      </span>
    `;
  } else {
    generateText.textContent = labels[currentLang].generate;
  }
}


  function handleReset() {
    form.reset();
    selectedDayKey = null;
    currentWorkout = null;
    clearError();
    showPlaceholder();
    // Clear BMI display
    const bmiDisplay = document.getElementById('bmiDisplay');
    if (bmiDisplay) bmiDisplay.textContent = '';
    
    // Reset nutrition type to vegetarian
    currentNutritionType = 'vegetarian';
  }

  function setActiveLanguage(lang) {
    const englishBtn = document.getElementById('lang-en');
    const hindiBtn = document.getElementById('lang-hi');

    if (englishBtn && hindiBtn) {
      englishBtn.className = "px-3 py-1 rounded-lg bg-gray-500 text-white text-xs font-medium transition-all duration-200 hover:bg-gray-600";
      hindiBtn.className = "px-3 py-1 rounded-lg bg-gray-500 text-white text-xs font-medium transition-all duration-200 hover:bg-gray-600";

      if (lang === 'en') {
        englishBtn.className = "px-3 py-1 rounded-lg bg-blue-600 text-white text-xs font-medium transition-all duration-200 hover:bg-blue-700";
      } else {
        hindiBtn.className = "px-3 py-1 rounded-lg bg-blue-600 text-white text-xs font-medium transition-all duration-200 hover:bg-blue-700";
      }
    }
  }

  function translateLabels() {
    // Update labels
    const allLabels = document.querySelectorAll('label');

    allLabels.forEach(label => {
      const text = label.textContent.trim
();

      if (text === 'Client Name *' || text === '‡§ï‡•ç‡§≤‡§æ‡§á‡§Ç‡§ü ‡§®‡§æ‡§Æ *') {
        label.textContent = labels[currentLang].clientName;
      }
      else if (text === 'Age *' || text === '‡§Ü‡§Ø‡•Å *') {
        label.textContent = labels[currentLang].age;
      }
      else if (text === 'Height (cm) *' || text === '‡§≤‡§Ç‡§¨‡§æ‡§à (‡§∏‡•á‡§Æ‡•Ä) *') {
        label.textContent = labels[currentLang].height;
      }
      else if (text === 'Weight (kg) *' || text === '‡§µ‡§ú‡§® (‡§ï‡§ø‡§≤‡•ã) *') {
        label.textContent = labels[currentLang].weight;
      }
      else if (text === 'Gender *' || text === '‡§≤‡§ø‡§Ç‡§ó *') {
        label.textContent = labels[currentLang].gender;
      }
      else if (text.includes('Equipment') || text === '‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§â‡§™‡§ï‡§∞‡§£ *') {
        label.textContent = labels[currentLang].equipment;
      }
      else if (text === 'Fitness Goal *' || text === '‡§´‡§ø‡§ü‡§®‡•á‡§∏ ‡§≤‡§ï‡•ç‡§∑‡•ç‡§Ø *') {
        label.textContent = labels[currentLang].goal;
      }
      else if (text === 'Workout Days per Week *' || text === '‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§Æ‡•á‡§Ç ‡§µ‡•ç‡§Ø‡§æ‡§Ø‡§æ‡§Æ ‡§¶‡§ø‡§® *') {
        label.textContent = labels[currentLang].workoutDays;
      }
      else if (text === 'Fitness Level *' || text === '‡§´‡§ø‡§ü‡§®‡•á‡§∏ ‡§∏‡•ç‡§§‡§∞ *') {
        label.textContent = labels[currentLang].fitnessLevel;
      }
    });

    // Update placeholders
    const clientInput = document.getElementById('Client');
    if (clientInput) clientInput.placeholder = labels[currentLang].enterName;

    const ageInput = document.getElementById('Age');
    if (ageInput) ageInput.placeholder = labels[currentLang].enterAge;

    // Update buttons
    const generateText = document.getElementById('generate-text');
    if (generateText) generateText.textContent = labels[currentLang].generate;

    const resetBtn = document.getElementById('reset-btn');
    if (resetBtn) resetBtn.textContent = labels[currentLang].reset;

    updateDropdownOptions();
  }

  function updateDropdownOptions() {
    // Update Gender dropdown
    const genderOptions = document.querySelectorAll('#Gender option');
    if (genderOptions.length > 0) {
      genderOptions[0].textContent = labels[currentLang].selectGender;
      if (genderOptions[1]) genderOptions[1].textContent = labels[currentLang].male;
      if (genderOptions[2]) genderOptions[2].textContent = labels[currentLang].female;
    }

    // Update Equipment dropdown
    const equipmentOptions = document.querySelectorAll('#equipment option');
    if (equipmentOptions.length > 0) {
      equipmentOptions[0].textContent = labels[currentLang].selectEquipment;
      if (equipmentOptions[1]) equipmentOptions[1].textContent = labels[currentLang].fullGym;
      if (equipmentOptions[2]) equipmentOptions[2].textContent = labels[currentLang].homeGym;
      if (equipmentOptions[3]) equipmentOptions[3].textContent = labels[currentLang].bodyweight;
      if (equipmentOptions[4]) equipmentOptions[4].textContent = labels[currentLang].minimal;
    }

    // Update Goal dropdown
    const goalOptions = document.querySelectorAll('#Goal option');
    if (goalOptions.length > 0) {
      goalOptions[0].textContent = labels[currentLang].selectGoal;
      if (goalOptions[1]) goalOptions[1].textContent = labels[currentLang].weightLoss;
      if (goalOptions[2]) goalOptions[2].textContent = labels[currentLang].muscleGain;
      if (goalOptions[3]) goalOptions[3].textContent = labels[currentLang].strengthTraining;
      if (goalOptions[4]) goalOptions[4].textContent = labels[currentLang].endurance;
      if (goalOptions[5]) goalOptions[5].textContent = labels[currentLang].generalFitness;
      if (goalOptions[6]) goalOptions[6].textContent = labels[currentLang].toning;
    }

    // Update Days dropdown
    const daysOptions = document.querySelectorAll('#WorkoutDays option');
    if (daysOptions.length > 0) {
      daysOptions[0].textContent = labels[currentLang].selectDays;
      for (let i = 1; i <= 7; i++) {
        if (daysOptions[i]) {
          const dayKey = ['oneDay', 'twoDays', 'threeDays', 'fourDays', 'fiveDays', 'sixDays', 'sevenDays'][i-1];
          daysOptions[i].textContent = labels[currentLang][dayKey];
        }
      }
    }

    // Update Level dropdown
    const levelOptions = document.querySelectorAll('#FitnessLevel option');
    if (levelOptions.length > 0) {
      levelOptions[0].textContent = labels[currentLang].selectLevel;
      if (levelOptions[1]) levelOptions[1].textContent = labels[currentLang].beginner;
      if (levelOptions[2]) levelOptions[2].textContent = labels[currentLang].intermediate;
      if (levelOptions[3]) levelOptions[3].textContent = labels[currentLang].advanced;
    }
  }

// Supabase Authentication Functions
async function checkAuth() {
  try {
    const { data: { session }, error } = await supabase.auth.getSession();

    if (error || !session) {
      window.location.href = 'signin.html';
      return;
    }

    currentUser = session.user;

    // ENHANCED: Check if user profile exists in database
    const { data: profile, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .single();

    if (profileError) {
      console.error('Profile error:', profileError);
      
      // CRITICAL: If profile doesn't exist (user was deleted), force signout
      if (profileError.code === 'PGRST116' || profileError.message.includes('No rows')) {
        console.log('User profile deleted - forcing signout');
        await supabase.auth.signOut();
        alert('Your account has been removed. Please contact support for assistance.');
        window.location.href = 'index.html';
        return;
      }
      
      // Other profile errors - redirect to index
      window.location.href = 'index.html';
      return;
    }

    userProfile = profile;

    // Check if free user has exhausted plans on page load
    if (profile.subscription_plan === 'free' && profile.plans_generated >= profile.plans_limit) {
      console.log("Free plans exhausted on page load");
      showUpgradeModal();
      return;
    }

    addUserNavigation();

  } catch (error) {
    console.error('Auth check error:', error);
    // Force signout on any auth error
    await supabase.auth.signOut();
    window.location.href = 'index.html';
  }
}

// Compact and Professional Navigation
function addUserNavigation() {
  const body = document.body;
  
  const navHtml = `
    <div id="user-nav" style="position: fixed; top: 0; left: 0; right: 0; z-index: 9999; background: linear-gradient(135deg, #1F2937 0%, #374151 100%); border-bottom: 1px solid rgba(75, 85, 99, 0.3); box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <div style="max-width: 1400px; margin: 0 auto; padding: 8px 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; min-height: 45px;">
          
          <!-- Left: Logo + Welcome (Compact) -->
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="color: #F59E0B; font-weight: bold; font-size: 16px;">üèãÔ∏è FitCoach Pro</span>
            <span style="color: #D1D5DB; font-size: 13px; font-weight: 500;">
              Welcome, ${userProfile?.full_name || userProfile?.email?.split('@')[0] || 'Trainer'}
            </span>
          </div>
          
          <!-- Right: Plans + Buttons (Compact) -->
          <div style="display: flex; align-items: center; gap: 10px;">
            <!-- Plans Status -->
            <span style="color: #60A5FA; font-size: 13px; font-weight: 600; background: rgba(96, 165, 250, 0.1); padding: 4px 8px; border-radius: 6px;">
              ${userProfile?.subscription_plan === 'free' ? 
                `${userProfile.plans_limit - userProfile.plans_generated} free plans left` : 
                'Unlimited plans'
              }
            </span>
            
            <!-- Dashboard Button (Compact) -->
            <button id="nav-dashboard-btn" style="background: #3B82F6; color: white; padding: 6px 12px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
              üìä Dashboard
            </button>
            
            <!-- Sign Out Button (Compact) -->
            <button id="nav-signout-btn" style="background: #EF4444; color: white; padding: 6px 12px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
              üö™ Sign Out
            </button>
          </div>
          
        </div>
      </div>
    </div>
  `;
  
  body.insertAdjacentHTML('afterbegin', navHtml);
  
  // SMART MARGIN: Only 50px instead of 70px
  const existingContent = document.querySelector('div.flex.split-layout, .main-content, body > div');
  if (existingContent) {
    existingContent.style.marginTop = '50px'; // Reduced from 70px
    existingContent.style.transition = 'margin-top 0.3s ease';
  }
  
  // Event Listeners
  setTimeout(() => {
    const dashboardBtn = document.getElementById('nav-dashboard-btn');
    const signoutBtn = document.getElementById('nav-signout-btn');
    
    if (dashboardBtn) {
      dashboardBtn.addEventListener('click', function() {
        console.log("Dashboard clicked!");
        window.location.href = 'dashboard.html';
      });
      
      // Hover effects
      dashboardBtn.addEventListener('mouseover', () => {
        dashboardBtn.style.background = '#2563EB';
        dashboardBtn.style.transform = 'translateY(-1px)';
      });
      dashboardBtn.addEventListener('mouseout', () => {
        dashboardBtn.style.background = '#3B82F6';
        dashboardBtn.style.transform = 'translateY(0)';
      });
    }
    
    if (signoutBtn) {
      signoutBtn.addEventListener('click', async function() {
        console.log("Sign out clicked!");
        try {
          await supabase.auth.signOut();
          window.location.href = 'index.html';
        } catch (error) {
          window.location.href = 'index.html';
        }
      });
      
      // Hover effects
      signoutBtn.addEventListener('mouseover', () => {
        signoutBtn.style.background = '#DC2626';
        signoutBtn.style.transform = 'translateY(-1px)';
      });
      signoutBtn.addEventListener('mouseout', () => {
        signoutBtn.style.background = '#EF4444';
        signoutBtn.style.transform = 'translateY(0)';
      });
    }
  }, 100);
}




function goToDashboard() {
  console.log("Dashboard button clicked from navigation");
  
  // Try direct redirect first
  try {
    window.location.href = 'dashboard.html';
  } catch (error) {
    console.log('Direct redirect failed, trying window.open');
    window.open('dashboard.html', '_self');
  }
}


async function signOut() {
  console.log("Sign Out button clicked from navigation");
  
  try {
    // Sign out from Supabase
    const { error } = await supabase.auth.signOut();
    
    if (error) {
      console.error('Supabase signout error:', error);
    }
    
    // Clear local data
    currentUser = null;
    userProfile = null;
    
    // Force redirect to signin page
    window.location.href = 'index.html';
    
  } catch (error) {
    console.error('Sign out error:', error);
    
    // Force redirect anyway
    window.location.href = 'index.html';
  }
}



function showUpgradeModal() {
    console.log("showUpgradeModal called - creating modal");
    
    const modalHtml = `
        <div id="upgrade-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; text-align: center; margin: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <h2 style="color: #333; margin-bottom: 15px;">üö´ Free Plans Exhausted!</h2>
                <p style="color: #666; margin-bottom: 20px;">You've used all your free workout plans. Upgrade to continue creating unlimited plans for your clients!</p>
                
                <div style="background: #F3F4F6; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #1F2937; margin-bottom: 10px;">üíé Pro Plan - ‚Çπ499/month</h3>
                    <ul style="text-align: left; color: #6B7280; margin: 0; padding-left: 20px;">
                        <li>‚úÖ Unlimited workout plans</li>
                        <li>‚úÖ Premium exercise database</li>
                        <li>‚úÖ Priority support</li>
                        <li>‚úÖ Advanced customization</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="modal-upgrade-btn" style="background: #10B981; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        üöÄ Upgrade Now
                    </button>
                    <button id="modal-dashboard-btn" style="background: #6B7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        üìä Go to Dashboard
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Add event listeners after modal is added to DOM
    setTimeout(() => {
        const upgradeBtn = document.getElementById('modal-upgrade-btn');
        const dashboardBtn = document.getElementById('modal-dashboard-btn');
        
        if (upgradeBtn) {
            upgradeBtn.addEventListener('click', function() {
                console.log("Upgrade button clicked from modal");
                upgradeNow();
            });
        }
        
        if (dashboardBtn) {
            dashboardBtn.addEventListener('click', function() {
                console.log("Dashboard button clicked from modal");
                goToDashboard();
            });
        }
    }, 100);
}


function upgradeNow() {
    console.log("upgradeNow function called");
    
    // Close the modal first
    const modal = document.getElementById('upgrade-modal');
    if (modal) {
        modal.remove();
        console.log("Modal removed");
    }
    
    // Show professional "coming soon" message
    const comingSoonModal = `
        <div id="coming-soon-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10002; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 450px; text-align: center; margin: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <div style="color: #3B82F6; font-size: 48px; margin-bottom: 20px;">üöß</div>
                <h2 style="color: #1F2937; margin-bottom: 15px; font-size: 24px;">Upgrade Feature Coming Soon!</h2>
                <p style="color: #6B7280; margin-bottom: 20px; line-height: 1.6;">
                    We're working hard to bring you premium features! For now, you can:
                </p>
                <div style="background: #F9FAFB; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left;">
                    <p style="color: #374151; margin: 5px 0;">‚Ä¢ Contact our support team</p>
                    <p style="color: #374151; margin: 5px 0;">‚Ä¢ Get manual upgrade assistance</p>
                    <p style="color: #374151; margin: 5px 0;">‚Ä¢ Early access to premium features</p>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 25px;">
                    <button onclick="contactSupport()" style="background: #3B82F6; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        Contact Support
                    </button>
                    <button onclick="document.getElementById('coming-soon-modal').remove()" style="background: #6B7280; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer;">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', comingSoonModal);
    console.log("Coming soon modal shown");
    
    // Auto-remove after 15 seconds
    setTimeout(() => {
        const modal = document.getElementById('coming-soon-modal');
        if (modal) {
            modal.remove();
            console.log("Coming soon modal auto-removed");
        }
    }, 15000);
}


// ADD this new function
function closeComingSoonModal() {
    const modal = document.getElementById('coming-soon-modal');
    if (modal) {
        modal.remove();
    }
}

function contactSupport() {
    console.log("contactSupport function called");
    
    // Close any open modals
    const modal = document.getElementById('coming-soon-modal');
    if (modal) {
        modal.remove();
    }
    
    // Open WhatsApp for support
    const supportMessage = encodeURIComponent("Hi! I'm interested in upgrading my FitCoach Pro plan. Can you help me with premium features?");
    const whatsappUrl = `https://wa.me/918234567890?text=${supportMessage}`; // Replace with your actual support number
    
    window.open(whatsappUrl, '_blank');
    console.log("WhatsApp opened for support");
}



async function incrementPlanCount(clientName, planData) {
    if (!currentUser || !userProfile) return false;

    try {
        // CHECK: If free plan user has exhausted their limit, block generation
        if (userProfile.subscription_plan === 'free' && userProfile.plans_generated >= userProfile.plans_limit) {
            console.log("Free plans exhausted - blocking generation");
            showUpgradeModal();
            return false; // Block the generation
        }

        // Update plan count
        const { error: updateError } = await supabase
            .from('profiles')
            .update({ 
                plans_generated: userProfile.plans_generated + 1 
            })
            .eq('id', currentUser.id);

        if (updateError) {
            console.error('Error updating plan count:', updateError);
            return false;
        }

        // Save plan to database
        const { error: planError } = await supabase
            .from('workout_plans')
            .insert({
                user_id: currentUser.id,
                client_name: clientName,
                plan_data: planData
            });

        if (planError) {
            console.error('Error storing plan:', planError);
        }

        // Update local profile
        userProfile.plans_generated += 1;

        // Update navigation display
        const navSpan = document.querySelector('#user-nav span[style*="color: #60A5FA"]');
        if (navSpan && userProfile.subscription_plan === 'free') {
            const remaining = userProfile.plans_limit - userProfile.plans_generated;
            navSpan.textContent = remaining > 0 ? `${remaining} free plans left` : 'Free plans exhausted';
        }

        return true; // Allow generation

    } catch (error) {
        console.error('Error tracking plan usage:', error);
        return false;
    }
}


  window.incrementPlanCount = incrementPlanCount;

  // Initialize after DOM ready
  document.addEventListener('DOMContentLoaded', () => {
     if (typeof currentLang === 'undefined') {
    window.currentLang = 'en'; // Make it global
  }
   if (typeof currentNutritionType === 'undefined') {
    window.currentNutritionType = 'vegetarian'; // Default to vegetarian
  }
    checkAuth();
    
    // DOM refs
    rightPanel = document.getElementById('right-panel');
    form = document.getElementById('plan-form');
    generateBtn = document.getElementById('generate-btn');
    generateText = document.getElementById('generate-text');
    resetBtn = document.getElementById('reset-btn');
    errorBox = document.getElementById('error');
    errorText = document.getElementById('error-text');

    if (!rightPanel || !form) {
      console.error('Essential DOM elements not found. Aborting initialization.');
      return;
    }

    showPlaceholder();

    form.addEventListener('submit', handleSubmit);
    resetBtn.addEventListener('click', handleReset);

    // Language toggle setup with enhanced functionality
    const englishBtn = document.getElementById('lang-en');
    const hindiBtn = document.getElementById('lang-hi');

    if (englishBtn) {
      englishBtn.onclick = function() {
        currentLang = 'en';
        setActiveLanguage('en');
        translateLabels();

        calculateBMI(); 
        
        // Re-render workout display if it exists
        if (currentWorkout) {
          renderWorkout(currentWorkout);
        }
      };
    }

    if (hindiBtn) {
      hindiBtn.onclick = function() {
        currentLang = 'hi';
        setActiveLanguage('hi');
        translateLabels();

        calculateBMI();
        
        // Re-render workout display if it exists
        if (currentWorkout) {
          renderWorkout(currentWorkout);
        }
      };
    }
  setTimeout(() => {
    calculateBMI();
  }, 100);
    // Initialize with English
    translateLabels();
  });

  async function saveWorkoutPlanToDatabase(clientName, workoutData) {
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        console.error('No user found');
        return;
      }
      
      // Save workout plan to database
      const { error: planError } = await supabase
        .from('workout_plans')
        .insert([{
          user_id: user.id,
          client_name: clientName,
          plan_data: JSON.stringify(workoutData),
          created_at: new Date()
        }]);
      
      if (planError) {
        console.error('Plan save error:', planError);
        return;
      }
      
      // Update plans counter
      const { data: profile } = await supabase
        .from('profiles')
        .select('plans_generated, plans_limit, subscription_plan')
        .eq('id', user.id)
        .single();
      
      const newPlansGenerated = (profile.plans_generated || 0) + 1;
      
      await supabase
        .from('profiles')
        .update({ 
          plans_generated: newPlansGenerated,
          updated_at: new Date()
        })
        .eq('id', user.id);
      
      console.log('‚úÖ Plan saved and counter updated!');
      
      // Update the user profile data
      if (userProfile) {
        userProfile.plans_generated = newPlansGenerated;
      }
      
      // Update the navigation display
      const navSpan = document.querySelector('#user-nav span[style*="color: #60A5FA"]');
      if (navSpan && userProfile?.subscription_plan === 'free') {
        const remaining = userProfile.plans_limit - newPlansGenerated;
        navSpan.textContent = remaining > 0 ? `${remaining} free plans left` : 'Free plans exhausted';
      }
      
    } catch (error) {
      console.error('Database save error:', error);
    }
  }

})();

function calculateBMI() {
  console.log('calculateBMI function called');
  
  try {
    // Check if elements exist
    const heightInput = document.getElementById('height');
    const weightInput = document.getElementById('weight');
    const bmiDisplay = document.getElementById('bmiDisplay');
    
    if (!heightInput || !weightInput || !bmiDisplay) {
      console.error('BMI elements not found!');
      return;
    }
    
    const height = parseFloat(heightInput.value);
    const weight = parseFloat(weightInput.value);
    
    console.log('Height:', height, 'Weight:', weight);
    
    // Clear display if either field is empty or invalid
    if (!height || !weight || height <= 0 || weight <= 0) {
      bmiDisplay.textContent = '';
      return;
    }
    
    // Calculate BMI
    const heightInMeters = height / 100;
    const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);
    const bmiValue = parseFloat(bmi);
    
    // Category selection (with fallback for undefined currentLang)
    let category = '';
    const lang = typeof currentLang !== 'undefined' ? currentLang : 'en';
    
    if (lang === 'hi') {
      if (bmiValue < 18.5) category = '(‡§ï‡§Æ ‡§µ‡§ú‡§®)';
      else if (bmiValue < 25) category = '(‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø)';
      else if (bmiValue < 30) category = '(‡§Ö‡§ß‡§ø‡§ï ‡§µ‡§ú‡§®)';
      else category = '(‡§Æ‡•ã‡§ü‡§æ‡§™‡§æ)';
      
      bmiDisplay.textContent = `‡§¨‡•Ä‡§è‡§Æ‡§Ü‡§à: ${bmi} ${category}`;
    } else {
      if (bmiValue < 18.5) category = '(Underweight)';
      else if (bmiValue < 25) category = '(Normal)';
      else if (bmiValue < 30) category = '(Overweight)';
      else category = '(Obese)';
      
      bmiDisplay.textContent = `BMI: ${bmi} ${category}`;
    }
    
    console.log(`‚úÖ BMI calculated: ${bmi} ${category}`);
    
  } catch (error) {
    console.error('Error in calculateBMI:', error);
  }
}



function calculateBMIValue() {
  const heightInput = document.getElementById('height');
  const weightInput = document.getElementById('weight');
  
  if (!heightInput || !weightInput) return null;
  
  const height = parseFloat(heightInput.value);
  const weight = parseFloat(weightInput.value);
  
  if (!height || !weight || height <= 0 || weight <= 0) return null;
  
  const heightInMeters = height / 100;
  return parseFloat((weight / (heightInMeters * heightInMeters)).toFixed(1));
}


function getBMICategory(bmi) {
  const bmiValue = parseFloat(bmi);
  if (currentLang === 'hi') {
    if (bmiValue < 18.5) return labels[currentLang].underweight;
    if (bmiValue < 25) return labels[currentLang].normal;  
    if (bmiValue < 30) return labels[currentLang].overweight;
    return labels[currentLang].obese;
  } else {
    if (bmiValue < 18.5) return 'Underweight';
    if (bmiValue < 25) return 'Normal';  
    if (bmiValue < 30) return 'Overweight';
    return 'Obese';
  }
}

</script>

  <div class="flex split-layout h-screen bg-gray-900">

    <!-- LEFT: Form Panel -->
    <aside class="left-panel w-full lg:w-96 lg:max-w-96 bg-gradient-to-b from-gray-800 to-gray-900 p-6 overflow-y-auto h-screen">
      <div class="mb-6">
        <div class="text-center mb-6">
          <h1 class="text-2xl font-bold text-white mb-2">üèãÔ∏è FitCoach Pro</h1>
          <p class="text-gray-300 text-sm">Create Your Personalized Workout Plan</p>
        </div>

        <div id="lang-toggle" class="flex justify-center gap-2 mb-4">
          <button id="lang-en" type="button" class="px-3 py-1 rounded-lg bg-blue-600 text-white text-xs font-medium transition-all duration-200 hover:bg-blue-700">
            English
          </button>
          <button id="lang-hi" type="button" class="px-3 py-1 rounded-lg bg-gray-500 text-white text-xs font-medium transition-all duration-200 hover:bg-gray-600">
            ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä
          </button>
        </div>

        <!-- Hidden webhook checkbox - invisible but present in code -->
        <div id="webhook-container" class="flex items-center gap-3 mt-2">
          <input id="use-webhook" type="checkbox" checked> 
          <label for="use-webhook" class="text-xs text-gray-300">Use webhook (live)</label>
        </div>

        <div id="error" class="hidden mb-4 p-3 bg-red-900 border border-red-700 rounded-lg">
          <p id="error-text" class="text-red-300 text-sm"></p>
        </div>

        <form id="plan-form" class="space-y-4">
          <div>
            <label class="block text-xs font-medium text-gray-300 mb-1">Client Name *</label>
            <input id="Client" name="Client" type="text" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your name" required>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-300 mb-1">Age *</label>
            <input id="Age" name="Age" type="number" min="18" max="80" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your age" required>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Height (cm) *</label>
              <input id="height" name="height" type="number" min="100" max="220" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="170" required oninput="calculateBMI()">
            </div>
            
            <div>
              <label class="block text-xs font-medium text-gray-300 mb-1">Weight (kg) *</label>
              <input id="weight" name="weight" type="number" min="30" max="150" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="70" required oninput="calculateBMI()">
            </div>
          </div>

         <div class="mt-2">
  <p id="bmiDisplay" class="text-sm text-blue-400 font-medium text-center"></p>
</div>

          <div>
            <label class="block text-xs font-medium text-gray-300 mb-1">Gender *</label>
            <select id="Gender" name="Gender" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <option value="">Select Gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-300 mb-1">Available Equipment *</label>
            <select id="equipment" name="equipment" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <option value="">Select Equipment</option>
              <option value="Full Gym">Full Gym Equipment</option>
              <option value="Home Gym">Home Gym (Dumbbells/Bands)</option>
              <option value="Bodyweight">Bodyweight Only</option>
              <option value="Minimal">Minimal Equipment</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-300 mb-1">Fitness Goal *</label>
            <select id="Goal" name="Goal" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <option value="">Select Goal</option>
              <option value="Weight Loss">Weight Loss</option>
              <option value="Muscle Gain">Muscle Gain</option>
              <option value="Strength Training">Strength Training</option>
              <option value="Endurance">Endurance</option>
              <option value="General Fitness">General Fitness</option>
              <option value="Toning">Toning</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-300 mb-1">Workout Days per Week *</label>
            <select id="WorkoutDays" name="WorkoutDays" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <option value="">Select Days</option>
              <option value="1 days per week">1 days per week</option>
              <option value="2 days per week">2 days per week</option>
              <option value="3 days per week">3 days per week</option>
              <option value="4 days per week">4 days per week</option>
              <option value="5 days per week">5 days per week</option>
              <option value="6 days per week">6 days per week</option>
              <option value="7 days per week">7 days per week</option>
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-300 mb-1">Fitness Level *</label>
            <select id="FitnessLevel" name="FitnessLevel" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
              <option value="">Select Level</option>
              <option value="Beginner">Beginner (0-6 months)</option>
              <option value="Intermediate">Intermediate (6 months - 2 years)</option>
              <option value="Advanced">Advanced (2+ years)</option>
            </select>
          </div>

          <div class="space-y-3 pt-4">
            <button id="generate-btn" type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
              <span id="generate-text">üöÄ Generate Plan</span>
            </button>

            <button id="reset-btn" type="button" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 text-sm">üîÑ Reset Form</button>
          </div>
        </form>

        <div class="mt-6 text-center">
          <p class="text-gray-400 text-xs">Get your personalized workout plan instantly!</p>
          <p class="text-gray-500 text-xs mt-1">Live webhook integration enabled</p>
        </div>
      </div>
    </aside>

    <!-- RIGHT: Workout Display -->
    <main id="right-panel" class="right-panel flex-1 bg-gray-900 p-6 overflow-y-auto">
      <!-- Placeholder content rendered by JS -->
    </main>
  </div>

</body>
</html>

